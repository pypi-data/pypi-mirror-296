"use strict";(self.webpackChunk_atoti_jupyterlab_extension=self.webpackChunk_atoti_jupyterlab_extension||[]).push([[2776],{52776:(e,t,a)=>{a.r(t),a.d(t,{default:()=>w});var n=a(74389),s=a(90147),o=a(31529),i=a(93345),r=a(95889),l=a(28359),u=a(56142),c=a(40700),d=a(42396),y=a(29263);function p(e){return e.substring(5,e.length-1).split(",")}var m=a(11003),x=a(35390),f=a(4774),h=a(40570),g=a(90923);const v=e=>{const{formatMessage:t}=(0,r.useIntl)(),{onOk:a,onCancel:s,templatedName:o}=e,[l,u]=(0,i.useState)(""),[c,d]=(0,i.useState)(""),y=(e=>{const t=e.indexOf("$"),a=e.lastIndexOf("$");return e.substring(t,a+1)})(o),p=o.replace(y,l);return(0,n.FD)("div",{style:{width:400,display:"flex",flexDirection:"column"},children:[(0,n.FD)("div",{style:{flexGrow:1},children:[(0,n.Y)(g.Input,{style:{marginTop:8},placeholder:y,value:l,onChange:e=>u(e.target.value)}),(0,n.Y)(g.Input,{style:{marginTop:8},placeholder:"value",value:c,onChange:e=>d(e.target.value)})]}),(0,n.FD)("div",{css:h.css`
          height: 35px;
          display: flex;
          justify-content: flex-end;
          margin-top: 8px;
        `,children:[(0,n.Y)(g.Button,{css:h.css`
            &.ant-btn {
              margin-right: 8px;
            }
          `,onClick:s,children:t({id:"aui.cancel"})}),(0,n.Y)(g.Button,{onClick:()=>{a(p,c)},disabled:0===l.length||0===c.length||e.queryContext?.some((({key:e})=>e===p)),type:"primary",children:t({id:"aui.ok"})})]})]})},C=e=>{let t;const[a,s]=(0,i.useState)(null),o=t=>{isNaN(Number(t))&&"ALL"!==e.type||e.onValueChanged?.(t)};if((0,i.useEffect)((()=>{"BOOL"!==e.type&&"ENUM"!==e.type&&s(e.value)}),[e.type,e.value]),"BOOL"===e.type)t=(0,n.Y)(g.Checkbox,{checked:"true"===e.value,disabled:e.isDisabled,onChange:()=>e.onValueChanged?.("true"===e.value?"false":"true")});else if(e.isDisabled)t=e.value;else if(e.type.startsWith("ENUM")){const a=p(e.type);t=(0,n.Y)(g.Select,{value:e.value,size:"small",onChange:e.onValueChanged,disabled:e.isDisabled,children:a.map((e=>(0,n.Y)(g.Select.Option,{value:e,children:e},e)))})}else t=(0,n.Y)(g.Input,{value:a??"",onChange:e=>s(e.target.value),onBlur:e=>{o(e.target.value)},onPressEnter:e=>{o(e.currentTarget.value)},size:"small",disabled:e.isDisabled});return(0,n.FD)("div",{css:{display:"flex",marginRight:16},children:[(0,n.Y)("div",{css:{flexGrow:1,whiteSpace:"nowrap",textOverflow:"ellipsis",overflow:"hidden"},title:e.name,children:e.name}),(0,n.Y)("div",{css:{textAlign:"right",flexGrow:1,flexShrink:1,marginLeft:10,whiteSpace:"nowrap",textOverflow:"ellipsis",overflow:"hidden",minWidth:35},children:t})]},e.name)},b=["drillthrough.hiddencolumns","subcube"],N=["mdx.kpi","mdx.member","mdx.formatters","mdx.set","mdx.measureAlias","mdx.defaultmembers","user-authentication"],k=["dashboard","page","widget"],E=(e,{sectionName:t,pageKey:a,leafKey:n})=>{const s="dashboard"===t?e:"page"===t?(0,d.W)(e,a):(0,y.B)(e,a,n);if(!s)throw new Error(`Impossible to edit the ${t}'s query context, as its corresponding state was not found.`);return s},I=(e,t,a)=>{e.queryContext||(e.queryContext=[]),e.queryContext.splice(a,0,t)},K=({dashboardState:e,pageKey:t,leafKey:a,userQueryContext:n,sectionName:o,queryContextEntry:i,index:r})=>{let l=n,u=e;return"user"===o?l=(0,s.produce)(n,(e=>{e.splice(r,0,i)})):u=(0,s.produce)(e,(e=>{const n=E(e,{sectionName:o,pageKey:t,leafKey:a});I(n,i,r)})),[u,l]},O=(e,t)=>{if(!e.queryContext)return;const{queryContext:a}=e;a.splice(t,1),0===a.length&&delete e.queryContext},Y=({dashboardState:e,pageKey:t,leafKey:a,userQueryContext:n,sectionName:o,index:i})=>{let r=n,l=e;return"user"===o?r=(0,s.produce)(n,(e=>{e.splice(i,1)})):l=(0,s.produce)(e,(e=>{const n=E(e,{sectionName:o,pageKey:t,leafKey:a});O(n,i)})),[l,r]},w=e=>{const{dashboardState:t,pageKey:a,leafKey:d,onDashboardChange:y}=(0,l.M)(e)?e:{},{cube:h,dataModel:g}=(0,x.useCube)(e.widgetState),{widgetState:w,onWidgetChange:T}=e,{formatMessage:S}=(0,r.useIntl)(),[q,,]=(0,u.J)("canUseUserQueryContext");let D=k;q&&(D=["user",...k]);const Q=(0,x.useQueryContexts)(w,t,a),[,R]=(0,c.v)("userQueryContext"),[_,P]=(0,i.useState)(),M=function(e){const t=e.contextValues,[a]=(0,u.J)("contextValues");return(0,i.useMemo)((()=>"*"===a?t:(0,o.pickBy)(t,(({name:e})=>a.some((t=>e===t))))),[a,t])}(g),U=(0,i.useCallback)((e=>{if(M[e])return M[e].type;const t=(0,o.findKey)(M,(({name:t})=>e.startsWith(t.replace(/\$.*\$$/,""))));return t?M[t].type:"ALL"}),[M]),V=(0,i.useMemo)((()=>{const e=Object.values(M).filter((({name:e})=>!b.some((t=>e.startsWith(t))))),t=(0,o.groupBy)(e,(({category:e})=>e||"misc"));return Object.entries(t).map((([e,t])=>({caption:e,isFolder:!0,isActionable:!1,type:e,children:t.map((t=>{const a={type:"QUERY_CONTEXT_ENTRY",key:t.name};return{caption:t.name,type:e,isActionable:!0,isDisabled:D.every((e=>Q[e]?.some((({key:e})=>e===t.name)))),dragItem:a}}))})))}),[M,Q,D]),B=(0,i.useMemo)((()=>{const e={};return e.default={placeholder:S({id:"aui.tool.queryContextEditor.noQueryContextEntries"}),caption:S({id:"aui.tool.queryContextEditor.defaultSection"}),tiles:Object.values(h.contextValues).filter((({name:e})=>N.every((t=>!e.startsWith(t)))&&b.every((t=>!e.startsWith(t))))).map((({name:e,value:t},a)=>{const s={key:e,value:t,fromPosition:{sectionName:"default",tileIndex:a},type:"QUERY_CONTEXT_ENTRY"};return{caption:(0,n.Y)(C,{name:e,value:t,isDisabled:!0,type:U(e)}),dragItem:s,isDisabled:D.some((t=>Q[t]?.some((({key:t})=>t===e)))),isRemovable:!1}}))},D.forEach((o=>{const i=Q[o];e[o]={caption:S({id:`aui.tool.queryContextEditor.${o}Section`}),tiles:i?i.map((({key:e,value:i},r)=>{const l={key:e,value:i,fromPosition:{sectionName:o,tileIndex:r},type:"QUERY_CONTEXT_ENTRY"},u=D.slice(D.indexOf(o)+1).some((t=>Q[t]?.some((t=>e===t.key))));return{caption:(0,n.Y)(C,{name:e,value:i,type:U(e),isDisabled:u,onValueChanged:e=>{if(y&&t&&a&&d)if("user"===o){if(!Q.user)return;const t=(0,s.produce)(Q.user,(t=>{t[r].value=e}));R(t)}else{const n=(0,s.produce)(t,(t=>{E(t,{leafKey:d,pageKey:a,sectionName:o}).queryContext[r].value=e}));y(n)}else{const t=(0,s.produce)(w,(t=>{t.queryContext[r].value=e}));T(t)}}}),isRemovable:!0,isDisabled:u,dragItem:l}})):[]}})),_&&e[_.sectionName].tiles.splice(_.tileIndex,0,{caption:_.key,dragItem:null}),e}),[_,U,h.contextValues,Q,t,S,d,y,T,a,w,R,D]),L=(0,i.useCallback)((({sectionName:e,tileIndex:n})=>{if(y&&t&&a&&d){const[s,o]=Y({dashboardState:t,pageKey:a,leafKey:d,userQueryContext:Q.user||[],sectionName:e,index:n});s!==t&&y(s),o!==Q.user&&R(o)}else{const e=(0,s.produce)(w,(e=>{O(e,n)}));T(e)}}),[t,d,y,a,Q.user,w,T,R]),W=(0,i.useCallback)(((e,n,o)=>{const i=o??(Q[e]?.length||0);if(-1!==n.indexOf("$"))P({sectionName:e,tileIndex:i,key:n});else{const o={key:n,value:((e,t)=>{if(!e)return"";const a=t[e.name];if(e.type.startsWith("ENUM"))return p(e.type)[0];switch(e.type){case"BOOL":return void 0!==a?a.value:"true";case"LONG":case"INTEGER":case"DOUBLE":return void 0!==a?a.value:"0";default:return a?.value||""}})(M[n],h.contextValues)};if(y&&t&&a&&d){const[n,s]=K({dashboardState:t,pageKey:a,leafKey:d,userQueryContext:Q.user||[],sectionName:e,queryContextEntry:o,index:i});n!==t&&y(n),s!==Q.user&&R(s)}else{const e=(0,s.produce)(w,(e=>{I(e,o,i)}));T(e)}}}),[M,t,d,y,T,a,Q,w,h.contextValues,R]),A=(0,i.useCallback)((e=>{e.isActionable&&!Q.widget?.some((({key:t})=>t===e.caption))&&W("widget",e.caption)}),[W,Q]),$=(0,i.useCallback)(((e,n)=>{if(_){const o={key:e,value:n};if(y&&t&&a&&d){const[e,n]=K({dashboardState:t,pageKey:a,leafKey:d,userQueryContext:Q.user||[],sectionName:_.sectionName,queryContextEntry:o,index:_.tileIndex});e!==t&&y(e),n!==Q.user&&R(n)}else{const e=(0,s.produce)(w,(e=>{I(e,o,_.tileIndex)}));T(e)}P(void 0)}}),[t,d,y,T,a,_,w,R,Q.user]),j=(0,i.useCallback)((({dragItem:e,toPosition:{sectionName:n,tileIndex:s}})=>{if(y&&t&&a&&d){let o=t,i=Q.user??[];"default"!==e.fromPosition.sectionName&&([o,i]=Y({dashboardState:t,pageKey:a,leafKey:d,userQueryContext:Q.user||[],sectionName:e.fromPosition.sectionName,index:e.fromPosition.tileIndex})),"default"!==n&&([o,i]=K({dashboardState:o,pageKey:a,leafKey:d,userQueryContext:i||[],sectionName:n,index:s,queryContextEntry:{key:e.key,value:e.value}})),o!==t&&y(o),i!==Q.user&&R(i)}}),[t,d,y,a,R,Q.user]),F=(0,i.useCallback)((({dragItem:e,toPosition:{sectionName:t,tileIndex:a}})=>{W(t,e.key,a)}),[W]);return(0,n.FD)(x.ResizableEditor,{children:[(0,n.Y)(m.P,{value:V,isSearchVisible:!0,searchPlaceholder:S({id:"aui.tool.queryContextEditor.searchContextEntries"}),onClick:A,expandTrigger:"full-node"}),(0,n.Y)(f.s,{css:{overflow:"auto"},sections:B,dragItemTypes:["QUERY_CONTEXT_ENTRY"],canDrop:({dragItem:e,toPosition:{sectionName:t}})=>"QUERY_CONTEXT_ENTRY"===e.type&&"default"!==t&&e?.fromPosition?.sectionName!==t&&!Q[t]?.some((({key:t})=>t===e.key)),onTileRemoved:L,onTileMoved:j,onTileAdded:F,popoverProps:{innerHeight:110,position:_,content:_&&(0,n.Y)(v,{onOk:$,templatedName:_.key,onCancel:()=>P(void 0),queryContext:Q[_.sectionName]})}})]})}}}]);