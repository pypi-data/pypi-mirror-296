<!doctype html><html><head><title>{{title}}</title><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0,viewport-fit=cove"><meta http-equiv="X-UA-Compatible" content="IE=edge">{{contentrefresh|safe}}
<link rel="icon"  href="/static/smartui/img/favicon.ico"><link rel="stylesheet" href="/static/smartchart/js/fun.css?_=1">
<script src="/static/smartchart/js/jquery-2.2.3.min.js"></script>
{% if devhead %}<link rel="stylesheet" href="/static/smartchart/js/dev.css?_=3.1"><link rel="stylesheet" href="/static/smartchart/icon/iconfont.css?_=2"><link rel="stylesheet" href="/static/smartchart/editor/modal.css">{% endif %}
<script src="/static/smartui/js/vue.min.js"></script><link rel="stylesheet" href="/static/smartui/elementui/theme-chalk/index.css"><script src="/static/smartui/elementui/index.js"></script>
<style>
body {background-color: #f1f1f1;width: 100%;}
.el-table td.el-table__cell, .el-table th.el-table__cell.is-leaf {text-align: center;}
.el-table--border th.el-table__cell, .el-table__fixed-right-patch {color: #fff; border: none !important;text-align: center;}
.search_base_div{display:flex;justify-content:center;}
.search_div{background-color: #fff;padding:0.5rem;width:95%;margin-top:0.5rem;border-radius:1rem;}
.body_base_div{display:flex;justify-content:center;}
.body_div{background-color: #fff;padding:0.5rem;width:95%;margin-top:0.5rem;border-radius:1rem;}
.filter_base_div{display:flex;justify-content: center;align-items:center;}
.filter_div{width:99%;display:flex;justify-content: space-between;align-items:center}
.table_base_div{display:flex;justify-content:center;align-items:center;margin-top:1rem;}
.table_div{width:99%;display:flex;flex-direction: column;}
.el-descriptions__header{margin-bottom: 0;}
</style>{% block head %}{% endblock %}</head>
{% autoescape off %}{{linkhead}}{{devhead}}{% block body %}
<body>
<vue id="vue_app"  v-loading.fullscreen.lock="!startRender">
{% for div in div_list %}{{div}}{% endfor %}
<!--筛选功能行-->
{% block body_search %}
<div class="search_base_div" v-if="searchHead"><div class="search_div"><div style="display:flex;">{% include 'echart/part_search.html' %}</div></div></div>
{% endblock %}
<!--表格体-->
<div class="body_base_div" v-if="startRender">
<div class="body_div">
    <!--表格功能行-->
    <div class="filter_base_div">
        <div class="filter_div"><h2>{[title]}</h2>
        <div>
        {% block body_filter %}<template v-if="!searchHead">{% include 'echart/part_search.html' %}</template>{% endblock %}
         <el-input v-for="(value, key) in filterDict" v-model="filterDict[key]" size="mini" :placeholder="nameDict[key]||key" @input='data_filter()' :style="{width:inputWidth}"></el-input>
         <el-popconfirm :title="'execute:'+value[0]+'?'" v-for="(value, key) in actionDict" @confirm='action_batch(key)'>
            <el-button slot="reference" :disabled="isClicked"  size="mini" :style="{background:value[1],border:'none',color:'#fff'}" >{[value[0]]}</el-button>
         </el-popconfirm>
         </div>
        </div>
    </div>
    <!--表格容器-->
    <div class="table_base_div">
     <div class="table_div">
       {% block body_table %}
       <el-table
        :data="tableData.slice((currentPage-1)*pageSize, currentPage*pageSize)"
        size="mini"
        :header-cell-style="{ background: tableHeaderColor }"
        :row-class-name="tableRowClassName"
        border
        ref="multipleTable"
        :max-height="maxheight"
        @selection-change="handleSelectionChange"
        style="width: 100%;">
      <el-table-column type="expand" v-if="shortTableFields">
           <template slot-scope="scope">
            <el-descriptions  :column="3" size="mini"  border>
            <el-descriptions-item v-for="item in (tableFields||tableHead)" :key="item" :label="nameDict[item]||item" >
                <el-tag v-if="tagFields.includes(item)" :color="statusColor[item]" style="color:white" disable-transitions size="mini">{[scope.row[item]]}</el-tag>
              <el-image v-else-if="scope.row[item]&&typeDict[item]==='img'" :src="construct_img(scope.row[item])" style="width: 100px" :preview-src-list="[construct_img(scope.row[item])]" lazy></el-image>
                <span v-else>{[scope.row[item]]}</span>
            </el-descriptions-item>
        </el-descriptions>
        </template>
    </el-table-column>
        <!--自定义选择列-->
        <el-table-column type="selection" width="55" v-if="actionDict" key="1"></el-table-column>
        <!--自动列-->
        <el-table-column v-for="item in (shortTableFields||tableFields||tableHead)" :label="nameDict[item]||item" :width="widthDict[item]" :property="item" :key="item" sortable show-overflow-tooltip>
          <template slot-scope="scope">
              <el-tag v-if="tagFields.includes(item)" :color="statusColor[scope.row[item]]" style="color:white" disable-transitions>{[scope.row[item]]}</el-tag>
              <el-image v-else-if="scope.row[item]&&typeDict[item]==='img'" :src="construct_img(scope.row[item])" :preview-src-list="[construct_img(scope.row[item])]" lazy></el-image>
              <el-link v-else-if="scope.row[item]&&typeDict[item]==='file'" type="success" :href="construct_img(scope.row[item])" target="_blank">{[scope.row[item]]}</el-link>
              {% block body_table_column %}{% endblock %}
              <span  v-else>{[ scope.row[item]]}</span>
          </template>
        </el-table-column>
        <!--自定义操作列-->
        <el-table-column fixed="right" label="Operation" width="100" v-if="btnEdit||btnRequest||btnView" key="2">
          <template slot-scope="scope">
            <el-button type="text" size="mini" icon="el-icon-edit-outline" @click.stop="handleRequestClick(scope.row)" v-if="btnRequest"></el-button>
            <el-button type="text" size="mini" icon="el-icon-edit" @click.stop="handleEditClick(scope.row)" v-if="btnEdit"></el-button>
            <el-button type="text" size="mini"  icon="el-icon-view" @click.stop="handleViewClick(scope.row)" v-if="btnView"></el-button>
            {% block body_table_column_button %}{% endblock %}
          </template>
        </el-table-column>
       </el-table>
       <!--分页控件-->
       <el-pagination align='center' v-if="pageSize<10000" @size-change="handlerSizeChange" @current-change="handlerCurrentChange" :current-page="currentPage" :page-size="pageSize" layout="total,sizes,prev,pager,next,jumper" :total="tableData.length"></el-pagination>
      {% endblock %}
    </div>
    </div>
</div>
</div>
<!--新增修改页-->
{% block dialog_modify %}{% include 'echart/part_modify.html' %}{% endblock %}
<!--卡片页-->
{% block dialog_card %}
<el-dialog  :visible.sync="dialogTableVisible"  :width="dialogWidth">
    <el-descriptions  :title="title" :column="3" size="mini" border>
        <el-descriptions-item v-for="(value,item) in detail" :key="item" :label="nameDict[item]||item">
         <el-tag v-if="tagFields.includes(item)" :color="statusColor[item]" style="color:white" disable-transitions size="mini">{[value]}</el-tag>
        <el-image v-else-if="value&&typeDict[item]==='img'" :src="construct_img(value)" style="width: 100px" :preview-src-list="[construct_img(value)]" lazy></el-image>
        <span v-else>{[value]}</span>
        </el-descriptions-item>
    </el-descriptions>
</el-dialog>
{% endblock %}
<!--申批修改页-->
{% block dialog_request %}
<el-dialog :title="title+':变更需求'" :visible.sync="dialogFormVisible_r" :width="dialogWidth">
  <el-form ref="rform" :model="rform" :rules="rules" :label-width="formLabelWidth">
    <el-form-item  prop="code" label="主键">
      <el-input  v-model="rform.code" autocomplete="off" disabled></el-input>
    </el-form-item>
    <el-form-item  prop="columnname" label="列名">
      <el-select  v-model="rform.columnname" @change="rform_select_change">
        <el-option v-for="(value, key) in nameDict" :key="key" :label="value" :value="key"></el-option>
      </el-select>
    </el-form-item>
    <el-form-item  prop="oldvalue" label="旧值">
      <el-input  v-model="rform.oldvalue" autocomplete="off" disabled></el-input>
    </el-form-item>
    <el-form-item  prop="newvalue" label="新值">
      <el-input  v-model="rform.newvalue" autocomplete="off"></el-input>
    </el-form-item>
    <el-form-item  prop="request_remark" label="备注">
      <el-input  v-model="rform.request_remark" autocomplete="off"></el-input>
    </el-form-item>
  </el-form>
  <div slot="footer" class="dialog-footer">
    <el-button @click="dialogFormVisible_r = false" icon="el-icon-circle-close"></el-button>
    <el-button :disabled="isClicked" type="primary" @click.stop="update_data_r" icon="el-icon-success"></el-button>
  </div>
</el-dialog>
{% endblock %}
{% if devhead %}{% include 'echart/part_setup.html' %}{% endif %}
</vue>
</body>
{% endblock %}{% endautoescape %}
</html><script>const dashid={{ dashid }};const dsDict={{ dsdict|safe }};</script><script src="/static/smartchart/js/fun.js?_=5"></script>
{{footer|safe}}{% block javascript %}<script>
var vapp = new Vue({el: '#vue_app', delimiters: ['{[', ']}'],
     data: {
         startRender:false,
         multipleSelection: [],
         dialogTableVisible:false,
         detail:'',
         title:'测试CRUD',
         dashid:dashid,
         tableData:[],
         tableHead:[],
         tableFields:'',
         shortTableFields:'',
         fullData:[],
         modifyFlag:1,
         dialogFormVisible: false,
         total:1,
         isClicked:false,
         dialogFormVisible_r:false,
         dialogSetupVisible:false,
         setupform:'',
         clickRow:'',
         maxheight:600, //表格最大高度
         uploadpath:'test', //上传文件的路径
         searchHead:true,
         tableHeaderColor:'#475254',
         dialogWidth:'60%',

         btnDownload:true,
         btnAdd:true,
         btnSearch:true,
         btnEdit:false,
         btnView:false,
         btnRequest:false,
         currentPage:1,
         pageSize:30,
         formLabelWidth: '80px', //标签宽
         inputWidth: '100px', //筛选区输入宽
         nameDict:{}, //字段与名称的MAP
         typeDict:{}, //用于填报页面字段的类型
         form:{}, //当无aform和mform时生效
         aform:'', //新增表单字段
         mform:'', //修改表单字段
         autoform:{}, //自动提交的内容
         rform:{code:'', columnname:'', oldvalue:'', newvalue:'', request_remark:''}, //变更请求,tablename,codename,updater请写在数据集中
         constFields:['code'], //定义修改时只读的字段
         tagFields:[], //显示为tag样式的字段
         widthDict:{}, //字段的显示宽度
         optionDict:{}, //字段选项
         filterDict:'', //用于过滤的字段
         actionDict:'', //动作区按钮的定义
         searchDict:{}, //用于筛选的字段
         rules: '', //定义字段校验规则
         requiredFields:'',
         statusColor: {}, //定义tag字段显示的颜色

         table_id:0,
         add_id:1,
         update_id:1,
         audit_id:1,
         detail_id:2,
         action_id:3,
         uploadds:'', //上传文件的配置数据集


     },
     methods: {
        initializeForm(form)  {
          if (form && typeof form === 'string') {
            return form.split(',').reduce((acc, cur) => {
              acc[cur.trim()] = '';
              return acc;
            }, {});
          }
          return form;
         },
        transfer_config() {
            if (this.requiredFields) {
                this.rules = this.requiredFields.split(',').reduce((acc, cur) => {
                    acc[cur.trim()] = [{required: true, message: `请输入${this.nameDict[cur] || cur}`, trigger: 'blur'}];
                    return acc;
                }, {});
            }
            this.form = this.initializeForm(this.form);
            this.aform = this.initializeForm(this.aform);
            this.mform = this.initializeForm(this.mform);
            this.searchDict = this.initializeForm(this.searchDict);
            this.filterDict = this.initializeForm(this.filterDict);
            if (typeof this.constFields === 'string'){this.constFields=this.constFields.split(',').map(field => field.trim())}
            if (typeof this.tagFields === 'string'){this.tagFields=this.tagFields.split(',').map(field => field.trim())}
        },
         construct_img(name){
            return '/static/custom/'+this.uploadpath+'/'+name
         },
        handleViewClick(row) {
            this.dialogTableVisible = true;
            let param={};
            param[this.constFields[0]]=row[this.constFields[0]];
            ds_refresh(this.detail_id,param);
            this.detail = ds_createMap_all(eval('data'+this.detail_id))[0];
         },
        handlerSizeChange(val){
             this.currentPage = 1;
             this.pageSize=val;
         },
        handlerCurrentChange(val){
             this.currentPage = val;
         },
        handleSelectionChange(val) {
            this.multipleSelection = val;
        },

         // 共公区
        search(){
          for(let key in this.searchDict){
              if(this.typeDict[key]==='date'){
                let order_date = this.searchDict[key];
                ds_setParam(key + '_s', order_date?order_date[0]:'');
                ds_setParam(key + '_e', order_date?order_date[1]:'');
              }else if(this.searchDict[key] instanceof Array){
                ds_setParam(key, this.searchDict[key].map(item =>  "'" + item + "'").join(','));
              }
              else{ds_setParam(key, this.searchDict[key]);}
          }
          this.refreshTable();
          this.data_filter();
        },
        update_data(){
            this.stopClick();
            this.$refs.form.validate((valid)=>{
                if(valid) {
                    let param={};
                    for(let key in this.form){
                        if(this.constFields.indexOf(key)<1){
                            if(this.form[key] instanceof Array){
                                param[key] = this.form[key].join(',')
                            }else{param[key]=this.form[key];}
                        }
                    }
                    for(let key in this.autoform){
                        param[key]=this.autoform[key];
                    }
                    let res = ds_save(this.modifyFlag?this.update_id:this.add_id, param, this.modifyFlag);
                    if(res.status==200){
                     this.$message.success('完成数据保存 Completed Save');
                     this.refreshTable();
                     this.data_filter();
                     this.dialogFormVisible = false;
                    }
                   else{this.$message.error(res.msg);}
                 }
            });
         },
         //用于变更申请提交
        update_data_r(){
            this.stopClick();
            this.$refs.rform.validate((valid)=>{
                if(valid) {
                    let res = ds_save(this.audit_id, this.rform, this.modifyFlag);
                    if(res.status==200){
                     this.$message.success('完成提交,等待审核通过 Submitted, Wait for check');
                     this.dialogFormVisible_r = false;
                    }
                   else{this.$message.error(res.msg);}
                 }
            });
         },
        //功能批量处理
        action_batch(action){
            this.stopClick();
            let updatelist=[];
            for(item of this.multipleSelection){
                updatelist.push(item[this.constFields[0]]);
            }
            updatelist=`${updatelist.map(item =>  typeof item !== 'number' ? "'" + item + "'" : item).join(',')}`;
            let param={action:action,updatelist:updatelist};
            ds_refresh(this.action_id,param);
            this.refreshTable();
            this.data_filter();
        },
        handleEditClick(row) {
            this.modifyFlag=1;
            this.dialogFormVisible = true;
            if(this.mform){this.form=this.mform}
            this.clickRow=row;
            for (let key in this.form) {
                if(this.typeDict[key] === 'selects'){this.form[key] = row[key].split(',')}else{this.form[key] = row[key];}
            }
         },
        handleRequestClick(row) {
            this.modifyFlag=0;
            this.dialogFormVisible_r = true;
            this.clickRow=row;
            this.rform.code=row[this.constFields[0]];
         },
        handleAdd(){
            this.dialogFormVisible = true;
            this.modifyFlag=0;
            if(this.aform){this.form=this.aform}
            for(let key in this.form) {this.form[key] = "";}
         },
        daochu(){
            ds_download(this.title + '_下载', ds_mapToList(this.tableData));
         },
        tableRowClassName({row, rowIndex}) {return '';},
         //数据模糊过滤
        data_filter(){
            this.currentPage = 1;
            let tempData=this.fullData;
            for(let key in this.filterDict){
               let v = this.filterDict[key].trim();
               if(v){
                   let op=v[0];
                   if(['<','=','>','>=','<='].includes(op)){
                       if(v.length<2){return}
                       if(v[1]=='='){op=op+'='}
                       v=v.slice(op.length);
                       if(op=='='){op='=='}
                       let fun=eval(`item => item${op}'${v}'`);
                       tempData = tempData.filter(item => fun(item[key]));
                   }
                   else{
                       let regex = new RegExp(v, 'i');
                       tempData = tempData.filter(item => regex.test(item[key]));
                   }
               }
            }
            this.tableData = tempData;
        },
        stopClick(){
            this.isClicked = true;
            setTimeout(() => {
            this.isClicked = false;
            }, 1000);
        },
        refreshTable(){
            ds_refresh(0);
            this.tableHead = eval('data'+this.table_id)[0];
            this.tableData=ds_createMap_all(eval('data'+this.table_id));
            this.fullData=this.tableData;
        },
         //请求修改表单选择联想
        rform_select_change(){
            this.rform.oldvalue=this.clickRow[this.rform.columnname];
        },
        handleUpload(response, file, fileList){
         if(response.status===200){
             if(response.key){this.form[response.key]=response.data[0];}
             this.$message.success(response.msg);
         }else{this.$message.error(response.msg);}
       },
        beforeUpload(file) {
       // const isExcel = file.type === 'application/vnd.ms-excel' ||
        //  file.type === 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet';
       // if (!isExcel) {
        //  this.$message.error('只能上传Excel文件');
       // }
        const isLt2M = file.size / 1024 / 1024 < 5;
        if (!isLt2M) {
          this.$message.error('文件大小不能超过 5MB!');
        }
        return isLt2M;
      },
     }
});

</script>{% endblock %}{% if devhead %}<script>
$('#id_resetdrag').after('<a class="iconfont iconed_list pro" onclick="showSetup()"></a>');
vapp.setupform={
    searchHead:{label:'查询头',type:'switch',value:''},
    btnAdd:{label:'新增',type:'switch',value:'',default:true},
    btnSearch:{label:'查询',type:'switch',value:'',default:true},
    btnDownload:{label:'下载',type:'switch',value:'',default:true},
    btnEdit:{label:'编辑',type:'switch',value:'',default:false},
    btnView:{label:'查看',type:'switch',value:'',default:false},
    btnRequest:{label:'审批',type:'switch',value:'',default:false},

    title:{label:'标题',type:'input',value:''},
    tableHeaderColor:{label:'表头颜色',type:'color',value:'',default:'#475254'},
    table_id:{label:'表格ds',type:'number',value:'',default:0},
    add_id:{label:'新增ds',type:'number',value:'',default:1},
    update_id:{label:'更新ds',type:'number',value:'',default:1},
    audit_id:{label:'审批ds',type:'number',value:'',default:1},
    detail_id:{label:'详情ds',type:'number',value:'',default:2},
    action_id:{label:'功能ds',type:'number',value:'',default:3},
    uploadds:{label:'上传ds',type:'number',value:''},


    aform:{label:'新增字段',type:'input_dict',value:''},
    mform:{label:'修改字段',type:'input_dict',value:''},
    tableFields:{label:'表格字段',type:'input_list',value:''},
    shortTableFields:{label:'短表格字段',type:'input_list',value:''},
    constFields:{label:'只读字段',type:'input_list',value:''},
    requiredFields:{label:'必填字段',type:'input',value:''},
    searchDict:{label:'查询字段',type:'input_dict',value:''},
    filterDict:{label:'过滤字段',type:'input_dict',value:''},
    tagFields:{label:'tag字段',type:'input_list',value:''},
    inputWidth:{label:'查询框宽',type:'input',value:'',default:'100px'},
    formLabelWidth:{label:'标签宽度',type:'input',value:'',default:'80px'},
    dialogWidth:{label:'弹出宽度',type:'input',value:'',default:'60%'},
    maxheight:{label:'表格最大高度',type:'input',value:'',default:600},
    pageSize:{label:'表格页数量',type:'input',value:'',default:30},
    nameDict:{label:'字段映射',type:'text_dict',value:'',placeholder:"code:编码"},
    widthDict:{label:'字段宽度',type:'text_dict',value:'',placeholder:"code:100px"},
    typeDict:{label:'字段类型',type:'text_dict',value:'',placeholder:"status:select,photo:file"},
    statusColor:{label:'tag颜色',type:'text_dict',value:'',placeholder:"有钱:red"},
    actionDict:{label:'批量动作',type:'text_dict2',value:'',placeholder:'{"action1":["动作1","black"]}'},
    optionDict:{label:'选项定义',type:'text_dict2',value:'',placeholder:'{"status":[["A","状态A"],["B"]]}'},
};
function showSetup(){
   for(let key in vapp.setupform) {
       if(vapp[key]){
            if (vapp.setupform[key].type==='input_list') {
                vapp.setupform[key].value = vapp[key].join();
            } else if (vapp.setupform[key].type==='input_dict') {
                vapp.setupform[key].value = Object.keys(vapp[key]).join();
            } else if (vapp.setupform[key].type==='text_dict') {
                vapp.setupform[key].value = JSON.stringify(vapp[key]).replace(/[{}"]/g, '').replace(/:/g, ':').replace(/,/g, ',');
            } else if(vapp.setupform[key].type==='text_dict2'){vapp.setupform[key].value = JSON.stringify(vapp[key])}
            else {
                vapp.setupform[key].value = vapp[key];
            }}
       else{vapp.setupform[key].value = vapp[key];}
        }
   vapp.dialogSetupVisible=true;
}

vapp.save_crud=(save)=>{
    let crud=[];
    for(let key in vapp.setupform) {
        if(vapp.setupform[key].value) {
            if (vapp.setupform[key].type==='input_list') {
                vapp[key] = vapp.setupform[key].value.split(',').map(field => field.trim());
            } else if (vapp.setupform[key].type==='input_dict') {
                vapp[key] = vapp.initializeForm(vapp.setupform[key].value);
            } else if (vapp.setupform[key].type==='text_dict') {
                vapp[key] = vapp.setupform[key].value.split(",").reduce((result, item) => {
                    const [key, value] = item.split(":");
                    result[key.trim()] = value.trim();
                    return result;
                }, {});
            }else if(vapp.setupform[key].type==='text_dict2'){
               vapp[key] = JSON.parse(vapp.setupform[key].value);
            }
            else {
                vapp[key] = vapp.setupform[key].value;
            }
        }else{vapp[key] = vapp.setupform[key].value;}
        if(save){
            if(vapp[key]!=vapp.setupform[key].default){
            if(typeof vapp[key]==='string'){
                if(vapp[key]){crud.push(`vapp.${key}='${vapp[key]}'`)}
            }else if(typeof vapp[key]==='object'){
                crud.push(`vapp.${key}=${JSON.stringify(vapp[key])}`)
            }else{
                crud.push(`vapp.${key}=${vapp[key]}`)
            }
        }}
   }
    vapp.transfer_config();
    if(save) {
        $.ajax({
            type: "POST",
            async: false,
            url: "/echart/save_smartcrud/",
            data: {dashid: dashid, crud: `\/\/=start_crud=\/\/\n${crud.join(';\n')}\n\/\/=end_crud=\/\/`},
            success: function (data) {
                vapp.$message.success(data.msg);
            }
        });
    }
};
</script>
    <div class="modal" id="modal_iframe"><div class="modal-content modal-dash"><header class="modal-header" id="id_header">
<span class="close" onclick="hideModal()">×</span>SmartChart<a class='iconfont iconed_ds' onclick=dev_dseditor()>数据集</a><a class='iconfont iconed_chart' onclick=dev_dschart()>图形</a><a class='iconfont iconed_div' onclick=dev_dsdiv()>布局</a>
    <span class="editor_head"></span></header><div class="modal-body"><iframe id="iframepage" class="iframechart"  width="100%"></iframe></div></div></div><script src="/static/smartchart/js/dev.js?_=8.1"></script>{% endif %}
<script>var charts = [];{{echart_main|safe}}window.onresize = function(){for(var i = 0; i < charts.length; i++){charts[i].resize();}};</script>
{% block footer %}{% endblock %}<script>vapp.refreshTable();vapp.transfer_config();vapp.startRender=true;</script>
<!--powered by smartchart.cn,Designed by JohnYan mailto:84345999@qq.com, https://gitee.com/smartchart/smartchart you need keep this-->