"use strict";sap.ui.define(["sap/base/Log","sap/base/i18n/Localization","sap/m/ActionSheet","sap/m/Button","sap/m/MessageBox","sap/m/library","sap/ui/core/Theming","sap/ui/core/UIComponent","sap/ui/core/mvc/Controller","sap/ui/core/routing/History","../model/Frontend","../model/Lang","../model/UserData","./utils/BackendConnector","./utils/Cookies","./utils/Formatters","./utils/MockConnector"],function(e,t,o,n,s,r,i,a,l,c,g,h,d,u,f,m,p){"use strict";function M(e){return e&&e.__esModule&&typeof e.default!=="undefined"?e.default:e}const w=r["PlacementType"];const T=g["frontendModel"];const B=h["languageModel"];const L=d["userDataModel"];const k=M(u);const R=f["getCookie"];const S=f["setCookie"];const E=f["setCookieConsent"];const C=f["setDummyCSRFCookie"];const x=m["formatBtnTxtForSmallScreen"];const y=M(p);const v=l.extend("demo.spa.controller.BaseController",{constructor:function t(){l.prototype.constructor.apply(this,arguments);this.formatBtnTxtForSmallScreen=x;this.logger=e.getLogger(v.prototype.getMetadata().getName());this.mapThemeToAlias={sap_horizon_dark:"dark",sap_horizon:"light"};this.lastErrorTimestamp=0;this.themes={_controller:this,dark:"sap_horizon_dark",light:"sap_horizon",get system(){let e=this.light;try{e=window.matchMedia("(prefers-color-scheme:dark)").matches?this.dark:this.light}catch(e){this._controller.logger.error(String(e))}return e}}},_:function e(){this.onInit()},changeLanguage:function e(o){if(t.getLanguage()!==o){const e=new URL(window.location.href);if(!S("LANG",o)){e.searchParams.set("lang",o);window.history.pushState({path:e.href},"",e.href)}else{e.searchParams.delete("lang");window.history.pushState({path:e.href},"",e.href)}window.location.reload()}},createLanguageActionSheet:function e(t){const s=t.getSource();const r=this.getLangModel();const i=r.getData().supported.map(e=>new n({text:e.name,press:()=>this.changeLanguage(e.code)}));const a=new o({placement:w.Bottom,buttons:i});a.openBy(s)},errorToMessageBox:async function e(t,o){let n=await this.getBundleText(t);if(n===t){n=await this.getBundleText("error.unknown")}s.error(n,{details:o?String(o):undefined})},failedResponseToMessageBox:function e(t){if(t instanceof Response){if(t.status>=500){void this.errorToMessageBox("error.5xx")}else if(t.status>=400){t.json().then(e=>{if(String(e.details).toLowerCase().includes("csrf failed")){void this.errorToMessageBox("error.403CSRF",new Error(JSON.stringify(e)))}else if(e.i18n){if(e.i18n==="error.404"){void this.errorToMessageBox(e.i18n,new Error(t.url))}else{void this.errorToMessageBox(e.i18n)}}else{if(t.status===404){void this.errorToMessageBox(e.i18n,new Error(t.url))}else{void this.errorToMessageBox(`error.${t.status}`)}}}).catch(e=>{this.logger.error(String(e));if(t.status===404){void this.errorToMessageBox("error.404",new Error(t.url))}else{void this.errorToMessageBox(`error.${t.status}`)}})}else{this.logger.error("Response is not an error, since its status code is less than 400. "+"Thus, it should not be handled as a failed response.");return}}else if(t instanceof TypeError&&(t.message.includes("to fetch")||t.message.includes("to load resource"))){this.logger.error(String(t));void this.errorToMessageBox("error.checkConnection")}else{this.logger.error(String(t));void this.errorToMessageBox("error.unknown",t)}},getBundleText:function e(t,o){return this.getBundleTextByModel(t,this.getModel("i18n"),o)},getBundleTextByModel:async function e(t,o,n){return o.getResourceBundle().then(function(e){return e.getText(t,n)})},getFrontendModel:function e(){return this.getOwnerComponent().getModel("frontend")},getI18nBundle:function e(){return this.getI18nModel().getResourceBundle()},getI18nModel:function e(){return this.getModel("i18n")},getLangModel:function e(){return this.getOwnerComponent().getModel("lang")},getModel:function e(t){return this.getView().getModel(t)},getRouter:function e(){return a.getRouterFor(this)},getUserDataModel:function e(){return this.getOwnerComponent().getModel("userData")},hasMockBackend:function e(){if(URLSearchParams&&window.location.search){const e=new URLSearchParams(window.location.search);const t=e.get("useMockConnector")=="true";if(t){return true}}return false},loginUser:function e(t,o){window.django={username:t,user_id:o};this.logger.info(`logged in ${t} with id ${o}`);this.setUserNameAndId(t,o);this.getUserDataModel().fetch(["person","appointment","slot"])},navBack:function e(){const t=c.getInstance();const o=t.getPreviousHash();if(o!==undefined){window.history.go(-1)}else{this.getRouter().navTo("HOME")}},navToHome:function e(){this.getRouter().fireRouteMatched({name:"HOME"});this.getRouter().navTo("HOME")},noCSRFTokenMessageBox:async function e(){const t=()=>{this.navBack()};s.confirm(await this.getBundleText("cookieConsent.text"),{title:await this.getBundleText("cookieConsent.title"),actions:[s.Action.YES,s.Action.NO],onClose:function(e){if(e===s.Action.YES){E();C();document.location.reload()}else{t()}},emphasizedAction:s.Action.YES})},onInit:function e(){if(!v.isInitialized){this.initLogger();this.applyCookieAndUrlBasedSettings();this.initModels();this.initBackendConnection();this.attachNetworkErrorHandler();this.getRouter().attachRoutePatternMatched(e=>{this.adjustFullScreenToRoute(e)});v.isInitialized=true;this.logger.info("Base Initialization Done.")}else{this.logger.info("Skipping Base Initialization.")}},onNavBack:function e(){this.navBack()},setModel:function e(t,o){return this.getView().setModel(t,o)},setTheme:function e(t){const o=this.themes[t];if(o){i.setTheme(o)}else{this.logger.warning(`Theme "${t}" not found!`)}},setUserNameAndId:function e(t,o){this.getFrontendModel().setProperty("/currentUser/username",t);this.getFrontendModel().setProperty("/currentUser/user_id",o)},adjustFullScreenToRoute:function e(t){if(t.getParameter("name").includes("FULLSCREEN")){this.setFullScreenMode(true)}else{this.setFullScreenMode(false)}},applyCookieAndUrlBasedSettings:function e(){if(R("THEME")){this.setTheme(R("THEME"));this.logger.info(`Theme set to ${R("THEME")}`)}else{this.setTheme("system");this.logger.info("Theme set to system")}const o=new URL(window.location.href);const n=o.searchParams.get("lang");if(R("LANG")){t.setLanguage(R("LANG"));o.searchParams.delete("lang");window.history.pushState({path:o.href},"",o.href);this.logger.info(`Language set to ${R("LANG")}`)}else if(n){t.setLanguage(n);this.logger.info("Language not set")}},attachNetworkErrorHandler:function e(){this.lastErrorTimestamp=Date.now();window.addEventListener("unhandledrejection",e=>{const t=Date.now();try{const o=e.reason.message.includes("to fetch")||e.reason.message.includes("to load")||e.reason.message.includes("Load failed");if(e.reason instanceof TypeError&&o&&t-this.lastErrorTimestamp>2e3){this.logger.error(`NETWORK ERROR (${t-this.lastErrorTimestamp}ms since last): ${e.reason.message}`);this.lastErrorTimestamp=t;void this.errorToMessageBox("error.checkConnection",e.reason)}}catch(e){this.logger.error(String(e))}})},initBackendConnection:function e(){if(this.hasMockBackend()){v.connector=new y;this.logger.info("Using mock connector")}else{v.connector=new k;this.logger.info("Using backend connector")}},initLogger:function t(){e.setLevel(e.Level.ERROR);if(URLSearchParams&&window.location.search){const t=new URLSearchParams(window.location.search);const o=t.get("loglevel");if(["ALL","DEBUG","ERROR","FATAL","INFO","NONE","TRACE","WARNING"].includes(o)){e.setLevel(e.Level[o]);this.logger.info(`Log level set to ${o}`)}}},initModels:function e(){this.getOwnerComponent().setModel(T,"frontend");this.getOwnerComponent().setModel(L,"userData");this.getUserDataModel().setFailureMessageHandler(this.failedResponseToMessageBox.bind(this));this.getOwnerComponent().setModel(B,"lang")},setFullScreenMode:function e(t){this.getFrontendModel().setProperty("/fullScreenMode",t)}});v.isInitialized=false;return v});
//# sourceMappingURL=BaseController.js.map