# vim: filetype=apache
<VirtualHost 172.27.3.13:80>
    ServerName ar.corporatepharmacy.com
    ServerAlias ar2.corporatepharmacy.com
    ServerAdmin webmaster@corporatepharmacy.com
    ServerSignature Off
    
    # Logging
    LogLevel error
	ErrorLog /var/log/apache2/ar.corporatepharmacy.com-error.log
	CustomLog /var/log/apache2/ar.corporatepharmacy.com-access.log combined

    # Force to HTTPS
    RewriteEngine On
    RedirectMatch ^/(.*) https://ar.corporatepharmacy.com/$1
</VirtualHost>

<VirtualHost 172.27.3.13:443>
    ServerName ar.corporatepharmacy.com
    ServerAlias ar2.corporatepharmacy.com
	ServerAdmin webmaster@corporatepharmacy.com
	ServerSignature Off

    # Logging
    LogLevel error
	ErrorLog /var/log/apache2/ar.corporatepharmacy.com-error.log
	CustomLog /var/log/apache2/ar.corporatepharmacy.com-access.log combined

    # SSL
    SSLEngine on
    SSLCertificateFile /etc/apache2/ssl/wildcard.corporatepharmacy.com.crt-positive-ssl-2015
    SSLCertificateChainFile /etc/apache2/ssl/wildcard.corporatepharmacy.com.ca-bundle-2015
    SSLCertificateKeyFile /etc/apache2/ssl/wildcard.corporatepharmacy.com.key.sha2
    BrowserMatch "MSIE [2-6]" \
		nokeepalive ssl-unclean-shutdown \
		downgrade-1.0 force-response-1.0
    # MSIE 7 and newer should be able to use keepalive
    BrowserMatch "MSIE [17-9]" ssl-unclean-shutdown

    RewriteEngine On
    RewriteRule ^/ppayment$ /ppayment/ [R,L]
    RewriteRule ^/apps/(.*)$ /$1 [R,L]

    # Authentication
    <Location />
        AuthType Basic
        AuthName "Accounting Launchpad"
        AuthBasicProvider wsgi
        WSGIAuthUserScript /usr/local/srv/bd/etc/ar/auth.wsgi application-group=test.be.bluediamondrx.com
        Require valid-user
    </Location>

    # Resources
    Alias /css /usr/local/srv/bd/www/ar/css
    Alias /doc /usr/local/srv/bd/doc/ar
    Alias /html /usr/local/srv/bd/www/ar/html
    Alias /images /usr/local/srv/bd/www/ar/images
    Alias /js /usr/local/srv/bd/www/ar/js
    Alias /repo /usr/local/srv/bd/www/repo

    # WSGI
    WSGIScriptAlias / /usr/local/srv/bd/etc/ar/prod.wsgi
    WSGIDaemonProcess ar.corporatepharmacy.com13 processes=15 \
        threads=1 user=xhandler group=staff 
    WSGIProcessGroup ar.corporatepharmacy.com13
</VirtualHost>
