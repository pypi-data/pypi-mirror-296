<%!
import cpsar.controls as C

show_notifications = False
%>
<%inherit file="sr_page.tmpl" />
<%block name="head">
  <title>BSR Records</title>
  <link type='text/css' rel='stylesheet' href='/css/form.css'  />
  <link type='text/css' rel='stylesheet' href='/css/state_reporting.css' />
  <style type='text/css'>
  TABLE.results TH TD {
    cursor: pointer;
  }
  </style>
</%block>
<%def name='scripts()'>
  ${parent.scripts()}

  <script src='/js/jquery.tablesorter.min.js'></script>
  <script>
  $(document).ready(function() {
      $("TABLE.results").tablesorter();
  });
  </script>
</%def>

<%block name="header">
   <a href="/state_reporting">State Reporting</a> &rarr; Reconcile Entries
</%block>

${self.notifications()}


<form action="/xy_recon" method="POST">
  <table class='grid'>
  <tr>
    <td title=''>Send Date Start</td></td>
    <td>${C.DatePicker('send_date_start', value=q.send_date_start)}</td>
  </tr>
  <tr>
    <td title=''>Send Date End</td></td>
    <td>${C.DatePicker('send_date_end', value=q.send_date_end)}</td>
  </tr>
  <tr>
    <td>Trans #</td>
    <td>${C.TextBox('trans_id')}</td>
  </tr>
  <tr>
    <td title='State Control Number'>Source Reference #</td></td>
    <td>${C.TextBox('source_ref')}</td>
  </tr>
  <tr>
    <td title='bishop_number'>Bishop Reference #</td></td>
    <td>${C.TextBox('bishop_number')}</td>
  </tr>
  <tr>
    <td></td>
    <td><input type='submit' value='Search' /></td>
  </tr>
  </table>
</form>

% if entries:
  <table class='grid results'>
  <thead>
    <tr>
      <th title='Reconciled?'>R</th>
      <th colspan='4'>
        Outgoing
      </th>
      <th colspan='8'>
        Incoming
      </th>
    <tr>
      <th>Link</th>
      <th>Entry</th>
      <th>SRID</th>
      <th>Outgoing File</th>
      <th>Time</th>
      <th>Incoming File</th>
      <th>Bishop</th>
      <th>Source Name</th>
      <th>Source Ref #</th>
      <th>Bill Inv #</th>
      <th>Status</th>
      <th>Error</th>
      <th>Message</th>
    </tr>
  </thead>
  <tbody>
  % for r in entries:
  <tr>
    <td>
      <input type='checkbox' data-srid='${r["srid"]}' class='reconciled'
        % if r['reconciled']:
          checked='checked'
        % endif
      />
    </td>
    <td>
      % if r['trans_id']:
        <a href='/view_trans?trans_id=${r["trans_id"]}'>TX: ${r["trans_id"]}</a>
      % endif
      % if r['bill_id']:
        <a href='/sr_manual/report_file?bill_id=${r["bill_id"]}'>Bill: ${r["bill_id"]}</a>
      % endif
    </td>
    <td>${r['srid']}</td>
    <td>${r['outgoing_file_name']}</td>
    <td>
      % if r['ctime']:
        ${r['ctime'].strftime("%m/%d/%Y %H:%M:%S")}
      % endif
    </td>
    <td>${r['incoming_file_name']}</td>
    <td>${r['bishop_number']}</td>
    <td>${r['source_name']}</td>
    <td>${r['source_ref']}</td>
    <td>${r['bill_inv_nbr']}</td>
    <td>${r["bsr_message"]}</td>
    <td>${r['err_source']} ${r['stat_cat_code']} ${r['stat_code']}
      % if r['ber_message']:
         - ${r['ber_message']}
      % endif
    </td>

  </tr>
  % endfor
  </table>
% endif
<script type='text/javascript' src='/js/jquery-1.5.1.min.js'></script>
<script>
    $(function() {
      $("INPUT.reconciled").change(function() {
        $.post("/xy_recon/mark?srid=" + this.dataset.srid); 
      });
    });
</script>
