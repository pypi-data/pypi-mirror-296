<%!
import kcontrol
from cpsar.workqueue import WorkQueue
from cpsar.controls import GroupNumberListBox
%>
<%inherit file="page.tmpl" />
<%block name="head">
    <title>Work Queue</title>
    <link rel='stylesheet' type='text/css' href='/css/base.css' />
    <link rel='stylesheet' type='text/css' href='/css/form.css' />
    <style type='text/css'>
        #priority_list {
            border: thin inset #FFFFFF;
            display: none;
        }
        .priority-10 {
            background: #9b0000;
            color: #FFFFFF;
        }
        .priority-9 {
            background: orange;
        }
        .priority-8 {
            background: yellow;
        }
        .priority-7 {
            background: #34913B;
            color: #FFFFFF;
        }
        .priority-7 A {
            color: #FFFFFF;
            text-decoration: underline;
            }
        .priority-4 {
            background: #344191;
            color: #FFFFFF;
        }
        .priority-4 A {
            color: #FFFFFF;
            text-decoration: underline;
            }
        .priority-2 {
            background: #833491;
            color: #FFFFFF;
        }
        .priority-2 A {
            color: #FFFFFF;
            text-decoration: underline;
            }
        .priority-1 {
            color: #FFFFFF;
            background: #E3277E;
        }
        .priority-1 A {
            color: #FFFFFF;
            text-decoration: underline;
        }
        TR.item { display: none }
    </style>
</%block>
<%def name='scripts()'>
    <script type='text/javascript' src='/js/jquery-1.5.1.min.js'></script>
    <script type='text/javascript' src='/js/common.js'></script>
    <script type='text/javascript'>
    $(document).ready(function() {
        $("A.show_priority").click(function() {
                $("#priority_list").toggle();
        });
        $(".hide_work_item").each(function() {
            var btn = $(this);
            btn.click(function() {
                $.post("/ac_hide_workitem", {
                    job_class: btn.attr("job_class"),
                    group_number: btn.attr("group_number"),
                    group_auth: btn.attr("group_auth")},
                    function(data) {
                        if(data.errors.length > 0) {
                            alert(data.errors);
                            return;
                        } else {
                            btn.parent().parent().remove();
                        }
                    },
                    'json');
            });
        });


        $("A.job_class").click(onJobClassClick);
    });

    function onJobClassClick() {
      var $trow = $(this).parents("TR:first");
      var $rows = $trow.nextUntil("TR.job_class");
      $rows.each(function() {
        var $x = $(this);
        if($x.css("display") === 'table-row') {
          $(this).css("display", "none");
        } else {
          $(this).css("display", "table-row");
        }
      });
      return false;
    }
    </script>
</%def>
<%block name='header'>Work Queue</%block>
<div><a href='javascript:' class='show_priority'>
    Click to show priority definitions</a></div>

<div id='priority_list'>
  <dl>
   <dt class='priority-10'>10</dt>
   <dd>Haults processing of batch</dd>
   <dt class='priority-9'>9</dt>
   <dd>Haults processing of claims for a single group</dd>
   <dt class='priority-8'>8</dt>
   <dd>Claim is processed but sponsor may not pay (requiring rebill)</dd>
   <dt class='priority-7'>7</dt>
   <dd>Claim is skipped in auxiliary business function (State Reporting)</dd>
   <dt class='priority-4'>4</dt>
   <dd>Required to maintain consistency of internal records</dd>
   <dt class='priority-2'>2</dt>
   <dd>Internal</dd>
   <dt class='priority-1'>1</dt>
   <dd>Importance Unknown but required by external entity</dd>
  </dl>
</div>

<table class='form'>
 <thead>
 <tr>
  <th></th>
  <th></th>
  <th>DP</th>
  <th title='Priority'>P</th>
  <th>Group</th>
  <th>Ref#</th>
  <th>RX#</th>
  <th>Patient</th>
  <th>Description</th>
  <th>SSN</th>
  <th>DOI</th>
 </tr>
 </thead>
 <tbody>
 % for job_class, items in WorkQueue.visible_by_job_class():
<tr class='job_class'>
  <td colspan='100' class='job_class'>
    <a href='#' class='job_class'>${job_class}</a>
    (${len(items)})
  </td>
</tr>
 % for i in items:
    <%
    gn = i['group_number']
    ga = i['group_auth']
    priority = i['priority']
    %>
 <tr class='item priority-${priority}'>
    <td>
       <input type='button' job_class='${i['job_class']}'
              group_number='${i['group_number']}'
              group_auth='${i['group_auth']}'
              value='Hide'
              title='${i['job_class']}'
              class='hide_work_item' />
    </td>
    <td style='text-align: center'>
        % if not i['invoice_id']:
            <span style='background-color: purple;color: #FFFFFF'>
            TOP
            </span>
        % endif
    </td>
    <td>${i['date_processed'].strftime("%m/%d/%Y")}</td>
    <td>${priority}</td>
    <td align='right'>${i['client_name']} ${gn}</td>
    % if i['trans_id']:
        <td><a href='/view_trans?trans_id=${i['trans_id']}'>${ga}</a>
        </td>
    % else:
        <td>${ga}</td>
    % endif

    <td>${i['rx_number']}</td>
    <td><a href='/patient?patient_id=${i['patient_id']}'>
        ${i['first_name']} ${i['last_name']}</a></td>
    <td>${i['item_description']}</td>
    <td>${i['ssn']}</td>
    <td>${i['doi']}</td>
 </tr>
 % endfor
% endfor
 </tbody>
</table>
