"use strict";(self.webpackChunkjupyterlab_ws_chat_extension=self.webpackChunkjupyterlab_ws_chat_extension||[]).push([[337],{6337:(e,t,n)=>{n.r(t),n.d(t,{ActiveCellManager:()=>h,AutocompletionRegistry:()=>d,ChatModel:()=>r,ChatWidget:()=>ye,IAutocompletionRegistry:()=>c,buildChatSidebar:()=>be,buildErrorWidget:()=>w,chatIcon:()=>i,readIcon:()=>s,replaceCellIcon:()=>o});var a=n(7460);const i=new a.LabIcon({name:"jupyter-chat::chat",svgstr:'<svg xmlns="http://www.w3.org/2000/svg" height="16" viewBox="0 0 24 24" width="16">\n  <g class="jp-icon3" fill="#616161">\n    <path d="M0 0h24v24H0V0z" fill="none"/>\n    <path d="M15 4v7H5.17L4 12.17V4h11m1-2H3c-.55 0-1 .45-1 1v14l4-4h10c.55 0 1-.45 1-1V3c0-.55-.45-1-1-1zm5 4h-2v9H6v2c0 .55.45 1 1 1h11l4 4V7c0-.55-.45-1-1-1z"/>\n  </g>\n</svg>\n'}),s=new a.LabIcon({name:"jupyter-chat::read",svgstr:'<svg height="24px" viewBox="0 0 24 24" width="24px" xmlns="http://www.w3.org/2000/svg">\n  <g>\n    <path\n       style="display:inline;fill:none;fill-opacity:1;stroke:#545454;stroke-width:1.54693;stroke-linecap:butt;stroke-linejoin:miter;stroke-miterlimit:1.5;stroke-dasharray:none;stroke-opacity:1;paint-order:normal"\n       d="M 2.2734634,9 V 20.226537 H 21.726536 V 9" />\n    <path\n       style="display:inline;fill:none;stroke:#545454;stroke-width:1.54528;stroke-linecap:square;stroke-miterlimit:10"\n       transform="matrix(0.81805878,0.57513462,-0.81805878,0.57513462,0,0)"\n       d="M 9.5141659,-5.1535239 H 20.802967 V 6.1352773 H 9.5141659 Z" />\n  </g>\n</svg>\n'}),o=new a.LabIcon({name:"jupyter-ai::replace-cell",svgstr:'<svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">\n    <path fill-rule="evenodd" clip-rule="evenodd"\n        d="M12 4.71429V7H1.71429V4.71429H12ZM12.5714 3C13.2026 3 13.7143 3.51168 13.7143 4.14286V7.57143C13.7143 8.20263 13.2026 8.71429 12.5714 8.71429H1.14286C0.51168 8.71429 0 8.20263 0 7.57143V4.14286C0 3.51168 0.511669 3 1.14286 3H12.5714Z"\n        fill="#565656" />\n    <path fill-rule="evenodd" clip-rule="evenodd"\n        d="M14 8.71429V11H3.71429V8.71429H14ZM14.5714 7C15.2026 7 15.7143 7.51168 15.7143 8.14286V11.5714C15.7143 12.2026 15.2026 12.7143 14.5714 12.7143H3.14286C2.51168 12.7143 2 12.2026 2 11.5714V8.14286C2 7.51168 2.51167 7 3.14286 7H14.5714Z"\n        fill="#565656" />\n</svg>\n'});var l=n(4602);class r{constructor(e={}){var t,n;this._messages=[],this._unreadMessages=[],this._messagesInViewport=[],this._name="",this._isDisposed=!1,this._notificationId=null,this._messagesUpdated=new l.Signal(this),this._configChanged=new l.Signal(this),this._unreadChanged=new l.Signal(this),this._viewportChanged=new l.Signal(this),this._focusInputSignal=new l.Signal(this);const a=null!==(t=e.config)&&void 0!==t?t:{};this._config={stackMessages:!0,...a},this._commands=e.commands,this._activeCellManager=null!==(n=e.activeCellManager)&&void 0!==n?n:null}get messages(){return this._messages}get activeCellManager(){return this._activeCellManager}get id(){return this._id}set id(e){this._id=e}get name(){return this._name}set name(e){this._name=e}get lastRead(){var e;return void 0===this._id?0:null!==(e=JSON.parse(localStorage.getItem(`@jupyter/chat:${this._id}`)||"{}").lastRead)&&void 0!==e?e:0}set lastRead(e){if(void 0===this._id)return;const t=JSON.parse(localStorage.getItem(`@jupyter/chat:${this._id}`)||"{}");t.lastRead=e,localStorage.setItem(`@jupyter/chat:${this._id}`,JSON.stringify(t))}get config(){return this._config}set config(e){const t="stackMessages"in e&&this._config.stackMessages!==e.stackMessages,n="unreadNotifications"in e&&this._config.unreadNotifications!==e.unreadNotifications;this._config={...this._config,...e},this._configChanged.emit(this._config),t&&(this._config.stackMessages?this._messages.slice(1).forEach(((e,t)=>{const n=this._messages[t].sender.username;e.stacked=n===e.sender.username})):this._messages.forEach((e=>{delete e.stacked})),this._messagesUpdated.emit()),n&&!this._config.unreadNotifications&&this._notify(0)}get unreadMessages(){return this._unreadMessages}set unreadMessages(e){var t;const n=this._unreadMessages.filter((t=>!e.includes(t))),a=e.length-this._unreadMessages.length;if(this._unreadMessages=e,this._unreadChanged.emit(this._unreadMessages),this._notify(e.length,a>0),void 0!==this._id&&n.length){let e=!1,a=null!==(t=this.lastRead)&&void 0!==t?t:this.messages[n[0]].time;n.forEach((t=>{this.messages[t].time>a&&(a=this.messages[t].time,e=!0)})),e&&(this.lastRead=a)}}get messagesInViewport(){return this._messagesInViewport}set messagesInViewport(e){this._messagesInViewport=e,this._viewportChanged.emit(e)}get messagesUpdated(){return this._messagesUpdated}get configChanged(){return this._configChanged}get unreadChanged(){return this._unreadChanged}get viewportChanged(){return this._viewportChanged}get focusInputSignal(){return this._focusInputSignal}addMessage(e){}dispose(){this.isDisposed||(this._isDisposed=!0)}get isDisposed(){return this._isDisposed}formatChatMessage(e){return e}messageAdded(e){const t=this._messages.findIndex((t=>t.id===e.id));t>-1&&this._messages.splice(t,1);let n=this._messages.findIndex((t=>t.time>e.time));-1===n&&(n=this._messages.length),this.messagesInserted(n,[e])}messagesInserted(e,t){var n;const a=[],i=[],s=null!==(n=this.lastRead)&&void 0!==n?n:0;if(t.forEach(((t,n)=>{a.push(this.formatChatMessage(t)),t.time>s&&i.push(e+n)})),this._messages.splice(e,0,...a),this._config.stackMessages){const t=e+a.length-1,n=0===e?1:e,i=this._messages.length>t+1?t+1:t;for(let e=n;e<=i;e++){const t=this._messages[e],n=this._messages[e-1].sender.username;t.stacked=n===t.sender.username}}this._addUnreadMessages(i),this._messagesUpdated.emit()}messagesDeleted(e,t){this._messages.splice(e,t),this._messagesUpdated.emit()}focusInput(){this._focusInputSignal.emit()}_addUnreadMessages(e){const t=new Set(this._unreadMessages);e.forEach((e=>t.add(e))),this.unreadMessages=Array.from(t.values())}_notify(e,t=!1){this._commands&&(e&&this._config.unreadNotifications?this._commands.execute("apputils:update-notification",{id:this._notificationId,message:`${e} incoming message(s) ${this._name?"in "+this._name:""}`}).then((n=>{!n&&t&&this._commands.execute("apputils:notify",{type:"info",message:`${e} incoming message(s) in ${this._name}`}).then((e=>{this._notificationId=e}))})):this._notificationId&&(this._commands.execute("apputils:dismiss-notification",{id:this._notificationId}),this._notificationId=null))}}const c=new(n(7262).Token)("@jupyter/chat:IAutocompleteRegistry");class d{constructor(){this._default=null,this._autocompletions=new Map}get default(){return this._default}set default(e){null===e||this._autocompletions.has(e)?this._default=e:console.warn(`There is no registered completer with the name '${e}'`)}getDefaultCompletion(){if(null!==this._default)return this._autocompletions.get(this._default)}get(e){return this._autocompletions.get(e)}add(e,t,n=!1){return this._autocompletions.has(e)?(console.warn(`A completer with the name '${e}' is already registered`),!1):(this._autocompletions.set(e,t),(1===this._autocompletions.size||n)&&(this.default=e),!0)}remove(e){return this._autocompletions.delete(e)}removeAll(){this._autocompletions.clear()}}var u=n(7909),m=n(9480);class h{constructor(e){var t,n;this._onMainAreaChanged=()=>{var e,t;const n=null!==(t=null===(e=this._notebookTracker.currentWidget)||void 0===e?void 0:e.isVisible)&&void 0!==t&&t;n!==this._notebookVisible&&(this._notebookVisible=n,this._available=!!this._activeCell&&this._notebookVisible,this._availabilityChanged.emit(this._available))},this._onActiveCellChanged=(e,t)=>{var n;this._activeCell!==t&&(null===(n=this._activeCell)||void 0===n||n.model.stateChanged.disconnect(this._cellStateChange),this._activeCell=t,null==t||t.ready.then((()=>{var e,t;null===(e=this._activeCell)||void 0===e||e.model.stateChanged.connect(this._cellStateChange),this._available=!!this._activeCell&&this._notebookVisible,this._availabilityChanged.emit(this._available),null===(t=this._activeCell)||void 0===t||t.disposed.connect((()=>{this._activeCell=null}))})))},this._cellStateChange=(e,t)=>{var n;if("executionCount"===t.name){const e=null===(n=this._activeCell)||void 0===n?void 0:n.model.sharedModel,t=this._activeCellError;let a=null;e&&"outputs"in e&&(a=e.outputs.find((e=>"error"===e.output_type))||null),t!==a&&(this._activeCellError=a,this._activeCellErrorChanged.emit(this._activeCellError))}},this._notebookVisible=!1,this._activeCell=null,this._available=!1,this._activeCellError=null,this._availabilityChanged=new l.Signal(this),this._activeCellErrorChanged=new l.Signal(this),this._notebookTracker=e.tracker,this._notebookTracker.activeCellChanged.connect(this._onActiveCellChanged),null===(t=e.shell.currentChanged)||void 0===t||t.connect(this._onMainAreaChanged),e.shell instanceof u.LabShell&&(null===(n=e.shell.layoutModified)||void 0===n||n.connect(this._onMainAreaChanged)),this._onMainAreaChanged()}get available(){return this._available}get activeCellError(){return this._activeCellError}get availabilityChanged(){return this._availabilityChanged}get activeCellErrorChanged(){return this._activeCellErrorChanged}getContent(e=!1){var t;const n=null===(t=this._notebookTracker.activeCell)||void 0===t?void 0:t.model.sharedModel;if(!n)return null;if(!e)return{type:n.cell_type,source:n.getSource()};const a=this._activeCellError;return a?{type:"code",source:n.getSource(),error:{name:a.ename,value:a.evalue,traceback:a.traceback}}:null}insertAbove(e){const t=this._notebookTracker.currentWidget;t&&t.isVisible&&(m.NotebookActions.insertAbove(t.content),this.replace(e))}insertBelow(e){const t=this._notebookTracker.currentWidget;t&&t.isVisible&&(m.NotebookActions.insertBelow(t.content),this.replace(e))}async replace(e){var t;const n=this._notebookTracker.currentWidget;if(!n||!n.isVisible)return;const a=this._notebookTracker.activeCell;a&&(await a.ready,null===(t=a.editor)||void 0===t||t.model.sharedModel.setSource(e))}}var g=n(2200),p=n(3251),v=n(9276),f=n(3345),_=n.n(f),C=n(2276),b=n(3325);function y(e){return getComputedStyle(document.body).getPropertyValue(e).trim()}function E(e){const[t,n]=(0,f.useState)((0,C.A)());return(0,f.useEffect)((()=>{var t;async function a(){n(await async function(){await async function(){for(;!document.body.hasAttribute("data-jp-theme-light");)await new Promise((e=>setTimeout(e,100)))}();const e=document.body.getAttribute("data-jp-theme-light");return(0,C.A)({spacing:4,components:{MuiButton:{defaultProps:{size:"small"}},MuiFilledInput:{defaultProps:{margin:"dense"}},MuiFormControl:{defaultProps:{margin:"dense",size:"small"}},MuiFormHelperText:{defaultProps:{margin:"dense"}},MuiIconButton:{defaultProps:{size:"small"}},MuiInputBase:{defaultProps:{margin:"dense",size:"small"}},MuiInputLabel:{defaultProps:{margin:"dense"}},MuiListItem:{defaultProps:{dense:!0}},MuiOutlinedInput:{defaultProps:{margin:"dense"}},MuiFab:{defaultProps:{size:"small"}},MuiTable:{defaultProps:{size:"small"}},MuiTextField:{defaultProps:{margin:"dense",size:"small"}},MuiToolbar:{defaultProps:{variant:"dense"}}},palette:{background:{paper:y("--jp-layout-color1"),default:y("--jp-layout-color1")},mode:"true"===e?"light":"dark",primary:{main:y("--jp-brand-color1"),light:y("--jp-brand-color2"),dark:y("--jp-brand-color0")},error:{main:y("--jp-error-color1"),light:y("--jp-error-color2"),dark:y("--jp-error-color0")},warning:{main:y("--jp-warn-color1"),light:y("--jp-warn-color2"),dark:y("--jp-warn-color0")},success:{main:y("--jp-success-color1"),light:y("--jp-success-color2"),dark:y("--jp-success-color0")},text:{primary:y("--jp-ui-font-color1"),secondary:y("--jp-ui-font-color2"),disabled:y("--jp-ui-font-color3")}},shape:{borderRadius:2},typography:{fontFamily:y("--jp-ui-font-family"),fontSize:12,htmlFontSize:16,button:{textTransform:"capitalize"}}})}())}a(),null===(t=e.themeManager)||void 0===t||t.themeChanged.connect(a)}),[]),_().createElement(b.A,{theme:t},e.children)}function w(e){const t=g.ReactWidget.create(_().createElement(E,{themeManager:e},_().createElement(p.A,{sx:{width:"100%",height:"100%",boxSizing:"border-box",background:"var(--jp-layout-color0)",display:"flex",flexDirection:"column"}},_().createElement(p.A,{sx:{padding:4}},_().createElement(v.A,{severity:"error"},"There seems to be a problem with the Chat backend, please look at the JupyterLab server logs or contact your administrator to correct this problem.")))));return t.id="jupyter-chat::chat",t.title.icon=i,t.title.caption="Jupyter Chat",t}var x=n(7446),k=n(4087),M=n(6309),A=n(4079),S=n(5358),I=n(9578),j=n(3099),N=n(4838),R=n(8507),V=n(3981),T=n(2753),P=n(9260),H=n(1656);const z="jp-chat-input-container",B="jp-chat-send-button",D="jp-chat-cancel-button";function $(e){var t,n;const{autocompletionName:a,autocompletionRegistry:i,model:s}=e,o=(0,f.useRef)(),[l,r]=(0,f.useState)(e.value||""),[c,d]=(0,f.useState)(null!==(t=s.config.sendWithShiftEnter)&&void 0!==t&&t),u=(0,f.useRef)();(0,f.useEffect)((()=>{var e;const t=(e,t)=>{var n;d(null!==(n=t.sendWithShiftEnter)&&void 0!==n&&n)};s.configChanged.connect(t);const n=()=>{u.current&&u.current.focus()};return null===(e=s.focusInputSignal)||void 0===e||e.connect(n),()=>{var e,a;null===(e=s.configChanged)||void 0===e||e.disconnect(t),null===(a=s.focusInputSignal)||void 0===a||a.disconnect(n)}}),[s]);const[m,h]=(0,f.useState)([]),[g,v]=(0,f.useState)(!1),[C,b]=(0,f.useState)(!1);function y(e){"Enter"===e.key&&(g||"Enter"===e.key&&(c&&e.shiftKey||!c&&!e.shiftKey)&&(E(),e.stopPropagation(),e.preventDefault()))}function E(){r(""),e.onSend(l)}function w(){r(e.value||""),e.onCancel()}(0,f.useEffect)((()=>{void 0!==i&&(o.current=a?i.get(a):i.getDefaultCompletion(),void 0!==o.current&&(Array.isArray(o.current.commands)?h(o.current.commands):"function"==typeof o.current.commands&&o.current.commands().then((e=>{h(e)}))))}),[]),(0,f.useEffect)((()=>{var e,t;(null===(e=o.current)||void 0===e?void 0:e.opener)&&(l!==(null===(t=o.current)||void 0===t?void 0:t.opener)?""!==l||b(!1):b(!0))}),[l]);const x=c?_().createElement("span",null,"Press ",_().createElement("b",null,"Shift"),"+",_().createElement("b",null,"Enter")," to send message"):_().createElement("span",null,"Press ",_().createElement("b",null,"Shift"),"+",_().createElement("b",null,"Enter")," to add a new line");return _().createElement(p.A,{sx:e.sx,className:(0,N.A)(z)},_().createElement(R.A,{options:m,value:e.value,open:C,autoHighlight:!0,freeSolo:!0,componentsProps:{popper:{placement:"top"},paper:{sx:{border:"1px solid lightgray"}}},ListboxProps:{sx:{"& .MuiAutocomplete-option":{padding:2}}},renderInput:t=>_().createElement(V.A,{...t,fullWidth:!0,variant:"outlined",multiline:!0,onKeyDown:y,placeholder:"Start chatting",inputRef:u,InputProps:{...t.InputProps,endAdornment:_().createElement(T.A,{position:"end"},e.onCancel&&_().createElement(M.A,{size:"small",color:"primary",onClick:w,title:"Cancel edition",className:(0,N.A)(D)},_().createElement(P.A,null)),_().createElement(M.A,{size:"small",color:"primary",onClick:E,disabled:e.onCancel?l===e.value:!l.trim().length,title:"Send message "+(c?"(SHIFT+ENTER)":"(ENTER)"),className:(0,N.A)(B)},_().createElement(H.A,null)))},FormHelperTextProps:{sx:{marginLeft:"auto",marginRight:0}},helperText:l.length>2?x:" "}),...null===(n=o.current)||void 0===n?void 0:n.props,inputValue:l,onInputChange:(e,t)=>{r(t)},onHighlightChange:(e,t)=>{v(!!t)},onClose:()=>{v(!1),b(!1)},disableClearable:!0}))}var F=n(7628),L=n(9193),W=n(7086),U=n(6644);const O=(0,L.Ay)((({className:e,...t})=>_().createElement(W.A,{...t,arrow:!0,classes:{popper:e}})))((({theme:e})=>({[`& .${U.A.tooltip}`]:{backgroundColor:e.palette.common.black,color:e.palette.common.white,boxShadow:e.shadows[1],fontSize:11},[`& .${U.A.arrow}`]:{color:e.palette.common.black}})));function J(e){var t;return _().createElement(O,{title:e.tooltip,placement:null!==(t=e.placement)&&void 0!==t?t:"top",slotProps:{popper:{modifiers:[{name:"offset",options:{offset:[0,-8]}}]}}},_().createElement("span",{className:e.className},_().createElement(M.A,{...e.iconButtonProps,onClick:e.onClick,disabled:e.disabled,sx:{lineHeight:0,...e.disabled&&{opacity:.5}},"aria-label":e["aria-label"]},e.children)))}var G;!function(e){e[e.None=0]="None",e[e.Copying=1]="Copying",e[e.Copied=2]="Copied"}(G||(G={}));const Z={[G.None]:"Copy to clipboard",[G.Copying]:"Copying…",[G.Copied]:"Copied!"};function K(e){const[t,n]=(0,f.useState)(G.None),i=(0,f.useRef)(null),s=(0,f.useCallback)((async()=>{if(t!==G.Copying){try{await navigator.clipboard.writeText(e.value)}catch(e){return console.error("Failed to copy text: ",e),void n(G.None)}n(G.Copied),i.current&&clearTimeout(i.current),i.current=window.setTimeout((()=>n(G.None)),1e3)}}),[t,e.value]);return _().createElement(J,{className:e.className,tooltip:Z[t],placement:"top",onClick:s,"aria-label":"Copy to clipboard"},_().createElement(a.copyIcon.react,{height:"16px",width:"16px"}))}const Y="jp-chat-code-toolbar-item";function q(e){var t,n;const{content:a,model:i}=e,[s,o]=(0,f.useState)(null===(t=i.config.enableCodeToolbar)||void 0===t||t),l=i.activeCellManager,[r,c]=(0,f.useState)({content:a,activeCellManager:l,activeCellAvailable:null!==(n=null==l?void 0:l.available)&&void 0!==n&&n});return(0,f.useEffect)((()=>{null==l||l.availabilityChanged.connect((()=>{c({content:a,activeCellManager:l,activeCellAvailable:l.available})})),i.configChanged.connect(((e,t)=>{var n;o(null===(n=t.enableCodeToolbar)||void 0===n||n)}))}),[i]),null!==l&&s?_().createElement(p.A,{sx:{display:"flex",justifyContent:"flex-end",alignItems:"center",padding:"6px 2px",marginBottom:"1em",border:"1px solid var(--jp-cell-editor-border-color)",borderTop:"none"},className:"jp-chat-code-toolbar"},_().createElement(Q,{...r,className:Y}),_().createElement(X,{...r,className:Y}),_().createElement(ee,{...r,className:Y}),_().createElement(K,{value:a,className:Y})):_().createElement(_().Fragment,null)}function Q(e){const t=e.activeCellAvailable?"Insert above active cell":"Insert above active cell (no active cell)";return _().createElement(J,{className:e.className,tooltip:t,onClick:()=>{var t;return null===(t=e.activeCellManager)||void 0===t?void 0:t.insertAbove(e.content)},disabled:!e.activeCellAvailable},_().createElement(a.addAboveIcon.react,{height:"16px",width:"16px"}))}function X(e){const t=e.activeCellAvailable?"Insert below active cell":"Insert below active cell (no active cell)";return _().createElement(J,{className:e.className,tooltip:t,disabled:!e.activeCellAvailable,onClick:()=>{var t;return null===(t=e.activeCellManager)||void 0===t?void 0:t.insertBelow(e.content)}},_().createElement(a.addBelowIcon.react,{height:"16px",width:"16px"}))}function ee(e){const t=e.activeCellAvailable?"Replace active cell":"Replace active cell (no active cell)";return _().createElement(J,{className:e.className,tooltip:t,disabled:!e.activeCellAvailable,onClick:()=>{var t;return null===(t=e.activeCellManager)||void 0===t?void 0:t.replace(e.content)}},_().createElement(o.react,{height:"16px",width:"16px"}))}function te(e){const t=[];if(void 0!==e.edit){const n=(0,a.ToolbarButtonComponent)({icon:a.editIcon,onClick:e.edit,tooltip:"Edit"});t.push(n)}if(void 0!==e.delete){const n=(0,a.ToolbarButtonComponent)({icon:a.deleteIcon,onClick:e.delete,tooltip:"Delete"});t.push(n)}return _().createElement("div",{className:"jp-chat-toolbar"},t.map((e=>e)))}const ne="text/markdown",ae=_().memo((function(e){const t=e.appendContent||!1,[n,a]=(0,f.useState)(null),[i,s]=(0,f.useState)([]);return(0,f.useEffect)((()=>{(async()=>{var t;const n=e.markdownStr.replace("\\(","\\\\(").replace("\\)","\\\\)").replace("\\[","\\\\[").replace("\\]","\\\\]"),i=e.rmRegistry.createModel({data:{[ne]:n}}),o=e.rmRegistry.createRenderer(ne);if(await o.renderModel(i),null===(t=e.rmRegistry.latexTypesetter)||void 0===t||t.typeset(o.node),!o.node)throw new Error("Rendermime was unable to render Markdown content within a chat message. Please report this upstream to Jupyter chat on GitHub.");const l=[];o.node.querySelectorAll("pre").forEach((t=>{var n;const a=document.createElement("div");null===(n=t.parentNode)||void 0===n||n.insertBefore(a,t.nextSibling),l.push([a,{model:e.model,content:t.textContent||""}])})),s(l),a(o.node)})()}),[e.markdownStr,e.rmRegistry]),_().createElement("div",{className:"jp-chat-rendermime-markdown"},n&&(t?_().createElement("div",{ref:e=>e&&e.appendChild(n)}):_().createElement("div",{ref:e=>e&&e.replaceChildren(n)})),_().createElement(te,{edit:e.edit,delete:e.delete}),i.map((e=>{const[t,n]=e;return(0,F.createPortal)(_().createElement(q,{...n}),t)})))}));function ie(e){const t=(0,f.useMemo)((()=>"jupyter-chat-scroll-container-"+Date.now().toString()),[]);return _().createElement(p.A,{id:t,sx:{overflowY:"scroll","& *":{overflowAnchor:"none"},...e.sx}},_().createElement(p.A,{sx:{minHeight:"100.01%"}},e.children),_().createElement(p.A,{sx:{overflowAnchor:"auto",height:"1px"}}))}const se="jp-chat-messages-container",oe="jp-chat-message",le="jp-chat-message-stacked",re="jp-chat-message-header",ce="jp-chat-message-time",de="jp-chat-navigation",ue="jp-chat-navigation-unread",me="jp-chat-navigation-top",he="jp-chat-navigation-bottom";function ge(e){const{model:t}=e,[n,a]=(0,f.useState)(t.messages),i=(0,f.useRef)(null),s=(0,f.useRef)([]),o=(0,f.useRef)(new IntersectionObserver((function(n){const a=[...t.unreadMessages];let i=!1;return n.forEach((e=>{var t;const n=parseInt(null!==(t=e.target.getAttribute("data-index"))&&void 0!==t?t:"");if(!isNaN(n)){if(a.length){const t=a.indexOf(n);-1!==t&&e.isIntersecting&&(a.splice(t,1),i=!0)}const t=s.current.indexOf(n);e.isIntersecting||-1===t?e.isIntersecting&&-1===t&&s.current.push(n):s.current.splice(t,1)}})),e.model.messagesInViewport=s.current,i&&(e.model.unreadMessages=a),()=>{var e;null===(e=o.current)||void 0===e||e.disconnect()}})));return(0,f.useEffect)((()=>{!async function(){t.getHistory&&t.getHistory().then((e=>a(e.messages))).catch((e=>console.error(e)))}()}),[t]),(0,f.useEffect)((()=>{function e(){a([...t.messages])}return t.messagesUpdated.connect(e),function(){t.messagesUpdated.disconnect(e)}}),[t]),_().createElement(_().Fragment,null,_().createElement(ie,{sx:{flexGrow:1}},_().createElement(p.A,{ref:i,className:(0,N.A)(se)},n.map(((t,n)=>_().createElement(p.A,{key:n,className:(0,N.A)(oe,t.stacked?le:"")},_().createElement(pe,{message:t}),_().createElement(ve,{...e,message:t,observer:o.current,index:n})))))),_().createElement(fe,{...e,refMsgBox:i}))}function pe(e){var t,n;const[a,i]=(0,f.useState)({}),s={height:"24px",width:"24px"},o=e.message,l=o.sender;(0,f.useEffect)((()=>{if(!a[o.time]){const e={};let t;const n=new Date,a=e=>e.getFullYear()===n.getFullYear()&&e.getMonth()===n.getMonth()&&e.getDate()===n.getDate(),s=new Date(1e3*o.time);t=a(s)?s.toLocaleTimeString([],{hour:"numeric",minute:"2-digit"}):s.toLocaleString([],{day:"numeric",month:"numeric",year:"numeric",hour:"numeric",minute:"2-digit"}),e[o.time]=t,i(e)}}));const r=l.color,c=o.stacked?null:l.avatar_url?_().createElement(I.A,{sx:{...s,...r&&{bgcolor:r}},src:l.avatar_url}):l.initials?_().createElement(I.A,{sx:{...s,...r&&{bgcolor:r}}},_().createElement(j.A,{sx:{fontSize:"var(--jp-ui-font-size1)",color:"var(--jp-ui-inverse-font-color1)"}},l.initials)):null,d=null!==(n=null!==(t=l.display_name)&&void 0!==t?t:l.name)&&void 0!==n?n:l.username||"User undefined";return _().createElement(p.A,{className:re,sx:{display:"flex",alignItems:"center","& > :not(:last-child)":{marginRight:3},marginBottom:o.stacked?"0px":"12px",...e.sx}},c,_().createElement(p.A,{sx:{display:"flex",flexGrow:1,flexWrap:"wrap",justifyContent:"space-between",alignItems:"center"}},_().createElement(p.A,{sx:{display:"flex",alignItems:"center"}},!o.stacked&&_().createElement(j.A,{sx:{fontWeight:700,color:"var(--jp-ui-font-color1)",paddingRight:"0.5em"}},d),(o.deleted||o.edited)&&_().createElement(j.A,{sx:{fontStyle:"italic",fontSize:"var(--jp-content-font-size0)"}},o.deleted?"(message deleted)":"(edited)")),_().createElement(j.A,{className:ce,sx:{fontSize:"0.8em",color:"var(--jp-ui-font-color2)",fontWeight:300},title:o.raw_time?"Unverified time":""},`${a[o.time]}${o.raw_time?"*":""}`)))}function ve(e){const{message:t,model:n,rmRegistry:a}=e,i=(0,f.useRef)(null),[s,o]=(0,f.useState)(!1),[l,r]=(0,f.useState)(!1),[c,d]=(0,f.useState)(!1),[u,m]=(0,f.useState)(!1);return(0,f.useEffect)((()=>{var t;if(null!==i.current)return null===(t=e.observer)||void 0===t||t.observe(i.current),()=>{var t;null!==i.current&&(null===(t=e.observer)||void 0===t||t.unobserve(i.current))}}),[n]),(0,f.useEffect)((()=>{var e;r(null!==(e=t.deleted)&&void 0!==e&&e),void 0===n.user||t.deleted?(d(!1),m(!1)):n.user.username===t.sender.username&&(d(void 0!==n.updateMessage),m(void 0!==n.deleteMessage))}),[n,t]),l?_().createElement("div",{ref:i,"data-index":e.index}):_().createElement("div",{ref:i,"data-index":e.index},s&&c?_().createElement($,{value:t.body,onSend:e=>((e,a)=>{if(!c)return;const i={...t};i.body=a,n.updateMessage(e,i),o(!1)})(t.id,e),onCancel:()=>{o(!1)},model:n}):_().createElement(ae,{rmRegistry:a,markdownStr:t.body,model:n,edit:c?()=>o(!0):void 0,delete:u?()=>{return e=t.id,void(u&&n.deleteMessage(e));var e}:void 0}))}function fe(e){const{model:t}=e,[n,i]=(0,f.useState)(!0),[s,o]=(0,f.useState)(null),[l,r]=(0,f.useState)(null),c=t=>{var n,a;null===(a=null===(n=e.refMsgBox.current)||void 0===n?void 0:n.children.item(t))||void 0===a||a.scrollIntoView()};return(0,f.useEffect)((()=>{var e;const n=(e,t)=>{const n=e.messagesInViewport;if(!n)return;let a=null!==s&&t.includes(s)&&s<Math.min(...n)?s:null,i=null!==l&&t.includes(l)&&l>Math.max(...n)?l:null;t.forEach((t=>{(null==n?void 0:n.includes(t))||(t<(null!=a?a:Math.min(...n))?a=t:t>Math.max(...n)&&t<(null!=i?i:e.messages.length)&&(i=t))})),o(a),r(i)};return null===(e=t.unreadChanged)||void 0===e||e.connect(n),n(t,t.unreadMessages),t.unreadMessages.length?c(Math.min(...t.unreadMessages)):c(t.messages.length-1),()=>{var e;null===(e=t.unreadChanged)||void 0===e||e.disconnect(n)}}),[t]),(0,f.useEffect)((()=>{var e,n;const a=(e,t)=>{i(t.includes(e.messages.length-1))};return null===(e=t.viewportChanged)||void 0===e||e.connect(a),a(t,null!==(n=t.messagesInViewport)&&void 0!==n?n:[]),()=>{var e;null===(e=t.viewportChanged)||void 0===e||e.disconnect(a)}}),[t]),_().createElement(_().Fragment,null,null!==s&&_().createElement(S.Button,{className:`${de} ${ue} ${me}`,onClick:()=>c(s),title:"Go to unread messages"},_().createElement(a.LabIcon.resolveReact,{display:"flex",icon:a.caretDownEmptyIcon,iconClass:(0,a.classes)("jp-Icon")})),(null!==l||!n)&&_().createElement(S.Button,{className:`${de} ${null!==l?ue:""} ${he}`,onClick:()=>c(null!==l?l:t.messages.length-1),title:null!==l?"Go to unread messages":"Go to last message"},_().createElement(a.LabIcon.resolveReact,{display:"flex",icon:a.caretDownEmptyIcon,iconClass:(0,a.classes)("jp-Icon")})))}function _e(e){const{model:t,rmRegistry:n,autocompletionRegistry:a}=e;return _().createElement(_().Fragment,null,_().createElement(ge,{rmRegistry:n,model:t}),_().createElement($,{onSend:async e=>{t.addMessage({body:e})},sx:{paddingLeft:4,paddingRight:4,paddingTop:3.5,paddingBottom:0,borderTop:"1px solid var(--jp-border-color1)"},model:t,autocompletionRegistry:a}))}function Ce(e){var t;const[n,a]=(0,f.useState)(e.chatView||Ce.View.chat);return _().createElement(E,{themeManager:null!==(t=e.themeManager)&&void 0!==t?t:null},_().createElement(A.A,{sx:{width:"100%",height:"100%",boxSizing:"border-box",background:"var(--jp-layout-color0)",display:"flex",flexDirection:"column"}},_().createElement(A.A,{sx:{display:"flex",justifyContent:"space-between"}},n!==Ce.View.chat?_().createElement(M.A,{onClick:()=>a(Ce.View.chat)},_().createElement(x.A,null)):_().createElement(A.A,null),n!==Ce.View.settings&&e.settingsPanel?_().createElement(M.A,{onClick:()=>a(Ce.View.settings)},_().createElement(k.A,null)):_().createElement(A.A,null)),n===Ce.View.chat&&_().createElement(_e,{model:e.model,rmRegistry:e.rmRegistry,autocompletionRegistry:e.autocompletionRegistry}),n===Ce.View.settings&&e.settingsPanel&&_().createElement(e.settingsPanel,null)))}function be(e){const t=g.ReactWidget.create(_().createElement(Ce,{...e}));return t.id="jupyter-chat::side-panel",t.title.icon=i,t.title.caption="Jupyter Chat",t}!function(e){let t;!function(e){e[e.chat=0]="chat",e[e.settings=1]="settings"}(t=e.View||(e.View={}))}(Ce||(Ce={}));class ye extends g.ReactWidget{constructor(e){super(),this.id="jupyter-chat::widget",this.title.icon=i,this.title.caption="Jupyter Chat",this._chatOptions=e}get model(){return this._chatOptions.model}render(){return _().createElement(Ce,{...this._chatOptions,model:this._chatOptions.model})}}}}]);