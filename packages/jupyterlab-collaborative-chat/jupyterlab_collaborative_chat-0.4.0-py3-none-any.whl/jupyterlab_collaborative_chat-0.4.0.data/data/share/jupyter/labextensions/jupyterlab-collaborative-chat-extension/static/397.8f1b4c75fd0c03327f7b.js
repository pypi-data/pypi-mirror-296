"use strict";(self.webpackChunkjupyterlab_collaborative_chat_extension=self.webpackChunkjupyterlab_collaborative_chat_extension||[]).push([[397],{397:(e,t,s)=>{s.r(t),s.d(t,{ChatPanel:()=>xe,ChatWidgetFactory:()=>Ae,CollaborativeChatModel:()=>fe,CollaborativeChatModelFactory:()=>Ne,CollaborativeChatPanel:()=>Me,CommandIDs:()=>ye,IActiveCellManagerToken:()=>we,IChatFactory:()=>Ce,IChatPanel:()=>be,WidgetConfig:()=>ke,YChat:()=>pe,chatFileType:()=>_e});var a=s(2200),n=s(3345),i=s.n(n),o=s(7446),r=s(4087),l=s(6309),c=s(4079),d=s(2276),h=s(3325);function u(e){return getComputedStyle(document.body).getPropertyValue(e).trim()}function m(e){const[t,s]=(0,n.useState)((0,d.A)());return(0,n.useEffect)((()=>{var t;async function a(){s(await async function(){await async function(){for(;!document.body.hasAttribute("data-jp-theme-light");)await new Promise((e=>setTimeout(e,100)))}();const e=document.body.getAttribute("data-jp-theme-light");return(0,d.A)({spacing:4,components:{MuiButton:{defaultProps:{size:"small"}},MuiFilledInput:{defaultProps:{margin:"dense"}},MuiFormControl:{defaultProps:{margin:"dense",size:"small"}},MuiFormHelperText:{defaultProps:{margin:"dense"}},MuiIconButton:{defaultProps:{size:"small"}},MuiInputBase:{defaultProps:{margin:"dense",size:"small"}},MuiInputLabel:{defaultProps:{margin:"dense"}},MuiListItem:{defaultProps:{dense:!0}},MuiOutlinedInput:{defaultProps:{margin:"dense"}},MuiFab:{defaultProps:{size:"small"}},MuiTable:{defaultProps:{size:"small"}},MuiTextField:{defaultProps:{margin:"dense",size:"small"}},MuiToolbar:{defaultProps:{variant:"dense"}}},palette:{background:{paper:u("--jp-layout-color1"),default:u("--jp-layout-color1")},mode:"true"===e?"light":"dark",primary:{main:u("--jp-brand-color1"),light:u("--jp-brand-color2"),dark:u("--jp-brand-color0")},error:{main:u("--jp-error-color1"),light:u("--jp-error-color2"),dark:u("--jp-error-color0")},warning:{main:u("--jp-warn-color1"),light:u("--jp-warn-color2"),dark:u("--jp-warn-color0")},success:{main:u("--jp-success-color1"),light:u("--jp-success-color2"),dark:u("--jp-success-color0")},text:{primary:u("--jp-ui-font-color1"),secondary:u("--jp-ui-font-color2"),disabled:u("--jp-ui-font-color3")}},shape:{borderRadius:2},typography:{fontFamily:u("--jp-ui-font-family"),fontSize:12,htmlFontSize:16,button:{textTransform:"capitalize"}}})}())}a(),null===(t=e.themeManager)||void 0===t||t.themeChanged.connect(a)}),[]),i().createElement(h.A,{theme:t},e.children)}var g=s(5358),p=s(7460),f=s(3251),v=s(7458),_=s(3099),C=s(4838),y=s(4214),b=s(3981),w=s(2753),E=s(9260),M=s(1656);const x="jp-chat-input-container",S="jp-chat-send-button",I="jp-chat-cancel-button";function k(e){var t,s;const{autocompletionName:a,autocompletionRegistry:o,model:r}=e,c=(0,n.useRef)(),[d,h]=(0,n.useState)(e.value||""),[u,m]=(0,n.useState)(null!==(t=r.config.sendWithShiftEnter)&&void 0!==t&&t),g=(0,n.useRef)();(0,n.useEffect)((()=>{var e;const t=(e,t)=>{var s;m(null!==(s=t.sendWithShiftEnter)&&void 0!==s&&s)};r.configChanged.connect(t);const s=()=>{g.current&&g.current.focus()};return null===(e=r.focusInputSignal)||void 0===e||e.connect(s),()=>{var e,a;null===(e=r.configChanged)||void 0===e||e.disconnect(t),null===(a=r.focusInputSignal)||void 0===a||a.disconnect(s)}}),[r]);const[p,v]=(0,n.useState)([]),[_,k]=(0,n.useState)(!1),[A,N]=(0,n.useState)(!1);function j(e){"Enter"===e.key&&(_||"Enter"===e.key&&(u&&e.shiftKey||!u&&!e.shiftKey)&&(R(),e.stopPropagation(),e.preventDefault()))}function R(){h(""),e.onSend(d)}function T(){h(e.value||""),e.onCancel()}(0,n.useEffect)((()=>{void 0!==o&&(c.current=a?o.get(a):o.getDefaultCompletion(),void 0!==c.current&&(Array.isArray(c.current.commands)?v(c.current.commands):"function"==typeof c.current.commands&&c.current.commands().then((e=>{v(e)}))))}),[]),(0,n.useEffect)((()=>{var e,t;(null===(e=c.current)||void 0===e?void 0:e.opener)&&(d!==(null===(t=c.current)||void 0===t?void 0:t.opener)?""!==d||N(!1):N(!0))}),[d]);const P=u?i().createElement("span",null,"Press ",i().createElement("b",null,"Shift"),"+",i().createElement("b",null,"Enter")," to send message"):i().createElement("span",null,"Press ",i().createElement("b",null,"Shift"),"+",i().createElement("b",null,"Enter")," to add a new line");return i().createElement(f.A,{sx:e.sx,className:(0,C.A)(x)},i().createElement(y.A,{options:p,value:e.value,open:A,autoHighlight:!0,freeSolo:!0,componentsProps:{popper:{placement:"top"},paper:{sx:{border:"1px solid lightgray"}}},ListboxProps:{sx:{"& .MuiAutocomplete-option":{padding:2}}},renderInput:t=>i().createElement(b.A,{...t,fullWidth:!0,variant:"outlined",multiline:!0,onKeyDown:j,placeholder:"Start chatting",inputRef:g,InputProps:{...t.InputProps,endAdornment:i().createElement(w.A,{position:"end"},e.onCancel&&i().createElement(l.A,{size:"small",color:"primary",onClick:T,title:"Cancel edition",className:(0,C.A)(I)},i().createElement(E.A,null)),i().createElement(l.A,{size:"small",color:"primary",onClick:R,disabled:e.onCancel?d===e.value:!d.trim().length,title:"Send message "+(u?"(SHIFT+ENTER)":"(ENTER)"),className:(0,C.A)(S)},i().createElement(M.A,null)))},FormHelperTextProps:{sx:{marginLeft:"auto",marginRight:0}},helperText:d.length>2?P:" "}),...null===(s=c.current)||void 0===s?void 0:s.props,inputValue:d,onInputChange:(e,t)=>{h(t)},onHighlightChange:(e,t)=>{k(!!t)},onClose:()=>{k(!1),N(!1)},disableClearable:!0}))}var A=s(7628),N=s(9193),j=s(7086),R=s(6644);const T=(0,N.Ay)((({className:e,...t})=>i().createElement(j.A,{...t,arrow:!0,classes:{popper:e}})))((({theme:e})=>({[`& .${R.A.tooltip}`]:{backgroundColor:e.palette.common.black,color:e.palette.common.white,boxShadow:e.shadows[1],fontSize:11},[`& .${R.A.arrow}`]:{color:e.palette.common.black}})));function P(e){var t;return i().createElement(T,{title:e.tooltip,placement:null!==(t=e.placement)&&void 0!==t?t:"top",slotProps:{popper:{modifiers:[{name:"offset",options:{offset:[0,-8]}}]}}},i().createElement("span",{className:e.className},i().createElement(l.A,{...e.iconButtonProps,onClick:e.onClick,disabled:e.disabled,sx:{lineHeight:0,...e.disabled&&{opacity:.5}},"aria-label":e["aria-label"]},e.children)))}var V;!function(e){e[e.None=0]="None",e[e.Copying=1]="Copying",e[e.Copied=2]="Copied"}(V||(V={}));const O={[V.None]:"Copy to clipboard",[V.Copying]:"Copyingâ€¦",[V.Copied]:"Copied!"};function D(e){const[t,s]=(0,n.useState)(V.None),a=(0,n.useRef)(null),o=(0,n.useCallback)((async()=>{if(t!==V.Copying){try{await navigator.clipboard.writeText(e.value)}catch(e){return console.error("Failed to copy text: ",e),void s(V.None)}s(V.Copied),a.current&&clearTimeout(a.current),a.current=window.setTimeout((()=>s(V.None)),1e3)}}),[t,e.value]);return i().createElement(P,{className:e.className,tooltip:O[t],placement:"top",onClick:o,"aria-label":"Copy to clipboard"},i().createElement(p.copyIcon.react,{height:"16px",width:"16px"}))}var F=s(9323);const U="jp-chat-code-toolbar-item";function $(e){var t,s;const{content:a,model:o}=e,[r,l]=(0,n.useState)(null===(t=o.config.enableCodeToolbar)||void 0===t||t),c=o.activeCellManager,[d,h]=(0,n.useState)({content:a,activeCellManager:c,activeCellAvailable:null!==(s=null==c?void 0:c.available)&&void 0!==s&&s});return(0,n.useEffect)((()=>{null==c||c.availabilityChanged.connect((()=>{h({content:a,activeCellManager:c,activeCellAvailable:c.available})})),o.configChanged.connect(((e,t)=>{var s;l(null===(s=t.enableCodeToolbar)||void 0===s||s)}))}),[o]),null!==c&&r?i().createElement(f.A,{sx:{display:"flex",justifyContent:"flex-end",alignItems:"center",padding:"6px 2px",marginBottom:"1em",border:"1px solid var(--jp-cell-editor-border-color)",borderTop:"none"},className:"jp-chat-code-toolbar"},i().createElement(B,{...d,className:U}),i().createElement(z,{...d,className:U}),i().createElement(W,{...d,className:U}),i().createElement(D,{value:a,className:U})):i().createElement(i().Fragment,null)}function B(e){const t=e.activeCellAvailable?"Insert above active cell":"Insert above active cell (no active cell)";return i().createElement(P,{className:e.className,tooltip:t,onClick:()=>{var t;return null===(t=e.activeCellManager)||void 0===t?void 0:t.insertAbove(e.content)},disabled:!e.activeCellAvailable},i().createElement(p.addAboveIcon.react,{height:"16px",width:"16px"}))}function z(e){const t=e.activeCellAvailable?"Insert below active cell":"Insert below active cell (no active cell)";return i().createElement(P,{className:e.className,tooltip:t,disabled:!e.activeCellAvailable,onClick:()=>{var t;return null===(t=e.activeCellManager)||void 0===t?void 0:t.insertBelow(e.content)}},i().createElement(p.addBelowIcon.react,{height:"16px",width:"16px"}))}function W(e){const t=e.activeCellAvailable?"Replace active cell":"Replace active cell (no active cell)";return i().createElement(P,{className:e.className,tooltip:t,disabled:!e.activeCellAvailable,onClick:()=>{var t;return null===(t=e.activeCellManager)||void 0===t?void 0:t.replace(e.content)}},i().createElement(F._z.react,{height:"16px",width:"16px"}))}function L(e){const t=[];if(void 0!==e.edit){const s=(0,p.ToolbarButtonComponent)({icon:p.editIcon,onClick:e.edit,tooltip:"Edit"});t.push(s)}if(void 0!==e.delete){const s=(0,p.ToolbarButtonComponent)({icon:p.deleteIcon,onClick:e.delete,tooltip:"Delete"});t.push(s)}return i().createElement("div",{className:"jp-chat-toolbar"},t.map((e=>e)))}const J="text/markdown",H=i().memo((function(e){const t=e.appendContent||!1,[s,a]=(0,n.useState)(null),[o,r]=(0,n.useState)([]);return(0,n.useEffect)((()=>{(async()=>{var t;const s=e.markdownStr.replace("\\(","\\\\(").replace("\\)","\\\\)").replace("\\[","\\\\[").replace("\\]","\\\\]"),n=e.rmRegistry.createModel({data:{[J]:s}}),i=e.rmRegistry.createRenderer(J);if(await i.renderModel(n),null===(t=e.rmRegistry.latexTypesetter)||void 0===t||t.typeset(i.node),!i.node)throw new Error("Rendermime was unable to render Markdown content within a chat message. Please report this upstream to Jupyter chat on GitHub.");const o=[];i.node.querySelectorAll("pre").forEach((t=>{var s;const a=document.createElement("div");null===(s=t.parentNode)||void 0===s||s.insertBefore(a,t.nextSibling),o.push([a,{model:e.model,content:t.textContent||""}])})),r(o),a(i.node)})()}),[e.markdownStr,e.rmRegistry]),i().createElement("div",{className:"jp-chat-rendermime-markdown"},s&&(t?i().createElement("div",{ref:e=>e&&e.appendChild(s)}):i().createElement("div",{ref:e=>e&&e.replaceChildren(s)})),i().createElement(L,{edit:e.edit,delete:e.delete}),o.map((e=>{const[t,s]=e;return(0,A.createPortal)(i().createElement($,{...s}),t)})))}));function G(e){const t=(0,n.useMemo)((()=>"jupyter-chat-scroll-container-"+Date.now().toString()),[]);return i().createElement(f.A,{id:t,sx:{overflowY:"scroll","& *":{overflowAnchor:"none"},...e.sx}},i().createElement(f.A,{sx:{minHeight:"100.01%"}},e.children),i().createElement(f.A,{sx:{overflowAnchor:"auto",height:"1px"}}))}const K="jp-chat-messages-container",Y="jp-chat-message",q="jp-chat-message-stacked",Q="jp-chat-message-header",X="jp-chat-message-time",Z="jp-chat-navigation",ee="jp-chat-navigation-unread",te="jp-chat-navigation-top",se="jp-chat-navigation-bottom";function ae(e){const{model:t}=e,[s,a]=(0,n.useState)(t.messages),o=(0,n.useRef)(null),r=(0,n.useRef)([]),l=(0,n.useRef)(new IntersectionObserver((function(s){const a=[...t.unreadMessages];let n=!1;return s.forEach((e=>{var t;const s=parseInt(null!==(t=e.target.getAttribute("data-index"))&&void 0!==t?t:"");if(!isNaN(s)){if(a.length){const t=a.indexOf(s);-1!==t&&e.isIntersecting&&(a.splice(t,1),n=!0)}const t=r.current.indexOf(s);e.isIntersecting||-1===t?e.isIntersecting&&-1===t&&r.current.push(s):r.current.splice(t,1)}})),e.model.messagesInViewport=r.current,n&&(e.model.unreadMessages=a),()=>{var e;null===(e=l.current)||void 0===e||e.disconnect()}})));return(0,n.useEffect)((()=>{!async function(){t.getHistory&&t.getHistory().then((e=>a(e.messages))).catch((e=>console.error(e)))}()}),[t]),(0,n.useEffect)((()=>{function e(){a([...t.messages])}return t.messagesUpdated.connect(e),function(){t.messagesUpdated.disconnect(e)}}),[t]),i().createElement(i().Fragment,null,i().createElement(G,{sx:{flexGrow:1}},i().createElement(f.A,{ref:o,className:(0,C.A)(K)},s.map(((t,s)=>i().createElement(f.A,{key:s,className:(0,C.A)(Y,t.stacked?q:"")},i().createElement(ne,{message:t}),i().createElement(ie,{...e,message:t,observer:l.current,index:s})))))),i().createElement(oe,{...e,refMsgBox:o}))}function ne(e){var t,s;const[a,o]=(0,n.useState)({}),r={height:"24px",width:"24px"},l=e.message,c=l.sender;(0,n.useEffect)((()=>{if(!a[l.time]){const e={};let t;const s=new Date,a=e=>e.getFullYear()===s.getFullYear()&&e.getMonth()===s.getMonth()&&e.getDate()===s.getDate(),n=new Date(1e3*l.time);t=a(n)?n.toLocaleTimeString([],{hour:"numeric",minute:"2-digit"}):n.toLocaleString([],{day:"numeric",month:"numeric",year:"numeric",hour:"numeric",minute:"2-digit"}),e[l.time]=t,o(e)}}));const d=c.color,h=l.stacked?null:c.avatar_url?i().createElement(v.A,{sx:{...r,...d&&{bgcolor:d}},src:c.avatar_url}):c.initials?i().createElement(v.A,{sx:{...r,...d&&{bgcolor:d}}},i().createElement(_.A,{sx:{fontSize:"var(--jp-ui-font-size1)",color:"var(--jp-ui-inverse-font-color1)"}},c.initials)):null,u=null!==(s=null!==(t=c.display_name)&&void 0!==t?t:c.name)&&void 0!==s?s:c.username||"User undefined";return i().createElement(f.A,{className:Q,sx:{display:"flex",alignItems:"center","& > :not(:last-child)":{marginRight:3},marginBottom:l.stacked?"0px":"12px",...e.sx}},h,i().createElement(f.A,{sx:{display:"flex",flexGrow:1,flexWrap:"wrap",justifyContent:"space-between",alignItems:"center"}},i().createElement(f.A,{sx:{display:"flex",alignItems:"center"}},!l.stacked&&i().createElement(_.A,{sx:{fontWeight:700,color:"var(--jp-ui-font-color1)",paddingRight:"0.5em"}},u),(l.deleted||l.edited)&&i().createElement(_.A,{sx:{fontStyle:"italic",fontSize:"var(--jp-content-font-size0)"}},l.deleted?"(message deleted)":"(edited)")),i().createElement(_.A,{className:X,sx:{fontSize:"0.8em",color:"var(--jp-ui-font-color2)",fontWeight:300},title:l.raw_time?"Unverified time":""},`${a[l.time]}${l.raw_time?"*":""}`)))}function ie(e){const{message:t,model:s,rmRegistry:a}=e,o=(0,n.useRef)(null),[r,l]=(0,n.useState)(!1),[c,d]=(0,n.useState)(!1),[h,u]=(0,n.useState)(!1),[m,g]=(0,n.useState)(!1);return(0,n.useEffect)((()=>{var t;if(null!==o.current)return null===(t=e.observer)||void 0===t||t.observe(o.current),()=>{var t;null!==o.current&&(null===(t=e.observer)||void 0===t||t.unobserve(o.current))}}),[s]),(0,n.useEffect)((()=>{var e;d(null!==(e=t.deleted)&&void 0!==e&&e),void 0===s.user||t.deleted?(u(!1),g(!1)):s.user.username===t.sender.username&&(u(void 0!==s.updateMessage),g(void 0!==s.deleteMessage))}),[s,t]),c?i().createElement("div",{ref:o,"data-index":e.index}):i().createElement("div",{ref:o,"data-index":e.index},r&&h?i().createElement(k,{value:t.body,onSend:e=>((e,a)=>{if(!h)return;const n={...t};n.body=a,s.updateMessage(e,n),l(!1)})(t.id,e),onCancel:()=>{l(!1)},model:s}):i().createElement(H,{rmRegistry:a,markdownStr:t.body,model:s,edit:h?()=>l(!0):void 0,delete:m?()=>{return e=t.id,void(m&&s.deleteMessage(e));var e}:void 0}))}function oe(e){const{model:t}=e,[s,a]=(0,n.useState)(!0),[o,r]=(0,n.useState)(null),[l,c]=(0,n.useState)(null),d=t=>{var s,a;null===(a=null===(s=e.refMsgBox.current)||void 0===s?void 0:s.children.item(t))||void 0===a||a.scrollIntoView()};return(0,n.useEffect)((()=>{var e;const s=(e,t)=>{const s=e.messagesInViewport;if(!s)return;let a=null!==o&&t.includes(o)&&o<Math.min(...s)?o:null,n=null!==l&&t.includes(l)&&l>Math.max(...s)?l:null;t.forEach((t=>{(null==s?void 0:s.includes(t))||(t<(null!=a?a:Math.min(...s))?a=t:t>Math.max(...s)&&t<(null!=n?n:e.messages.length)&&(n=t))})),r(a),c(n)};return null===(e=t.unreadChanged)||void 0===e||e.connect(s),s(t,t.unreadMessages),t.unreadMessages.length?d(Math.min(...t.unreadMessages)):d(t.messages.length-1),()=>{var e;null===(e=t.unreadChanged)||void 0===e||e.disconnect(s)}}),[t]),(0,n.useEffect)((()=>{var e,s;const n=(e,t)=>{a(t.includes(e.messages.length-1))};return null===(e=t.viewportChanged)||void 0===e||e.connect(n),n(t,null!==(s=t.messagesInViewport)&&void 0!==s?s:[]),()=>{var e;null===(e=t.viewportChanged)||void 0===e||e.disconnect(n)}}),[t]),i().createElement(i().Fragment,null,null!==o&&i().createElement(g.Button,{className:`${Z} ${ee} ${te}`,onClick:()=>d(o),title:"Go to unread messages"},i().createElement(p.LabIcon.resolveReact,{display:"flex",icon:p.caretDownEmptyIcon,iconClass:(0,p.classes)("jp-Icon")})),(null!==l||!s)&&i().createElement(g.Button,{className:`${Z} ${null!==l?ee:""} ${se}`,onClick:()=>d(null!==l?l:t.messages.length-1),title:null!==l?"Go to unread messages":"Go to last message"},i().createElement(p.LabIcon.resolveReact,{display:"flex",icon:p.caretDownEmptyIcon,iconClass:(0,p.classes)("jp-Icon")})))}function re(e){const{model:t,rmRegistry:s,autocompletionRegistry:a}=e;return i().createElement(i().Fragment,null,i().createElement(ae,{rmRegistry:s,model:t}),i().createElement(k,{onSend:async e=>{t.addMessage({body:e})},sx:{paddingLeft:4,paddingRight:4,paddingTop:3.5,paddingBottom:0,borderTop:"1px solid var(--jp-border-color1)"},model:t,autocompletionRegistry:a}))}function le(e){var t;const[s,a]=(0,n.useState)(e.chatView||le.View.chat);return i().createElement(m,{themeManager:null!==(t=e.themeManager)&&void 0!==t?t:null},i().createElement(c.A,{sx:{width:"100%",height:"100%",boxSizing:"border-box",background:"var(--jp-layout-color0)",display:"flex",flexDirection:"column"}},i().createElement(c.A,{sx:{display:"flex",justifyContent:"space-between"}},s!==le.View.chat?i().createElement(l.A,{onClick:()=>a(le.View.chat)},i().createElement(o.A,null)):i().createElement(c.A,null),s!==le.View.settings&&e.settingsPanel?i().createElement(l.A,{onClick:()=>a(le.View.settings)},i().createElement(r.A,null)):i().createElement(c.A,null)),s===le.View.chat&&i().createElement(re,{model:e.model,rmRegistry:e.rmRegistry,autocompletionRegistry:e.autocompletionRegistry}),s===le.View.settings&&e.settingsPanel&&i().createElement(e.settingsPanel,null)))}!function(e){let t;!function(e){e[e.chat=0]="chat",e[e.settings=1]="settings"}(t=e.View||(e.View={}))}(le||(le={}));class ce extends a.ReactWidget{constructor(e){super(),this.id="jupyter-chat::widget",this.title.icon=F.Or,this.title.caption="Jupyter Chat",this._chatOptions=e}get model(){return this._chatOptions.model}render(){return i().createElement(le,{...this._chatOptions,model:this._chatOptions.model})}}var de=s(2135),he=s(4602);class ue{constructor(e={}){var t,s;this._messages=[],this._unreadMessages=[],this._messagesInViewport=[],this._name="",this._isDisposed=!1,this._notificationId=null,this._messagesUpdated=new he.Signal(this),this._configChanged=new he.Signal(this),this._unreadChanged=new he.Signal(this),this._viewportChanged=new he.Signal(this),this._focusInputSignal=new he.Signal(this);const a=null!==(t=e.config)&&void 0!==t?t:{};this._config={stackMessages:!0,...a},this._commands=e.commands,this._activeCellManager=null!==(s=e.activeCellManager)&&void 0!==s?s:null}get messages(){return this._messages}get activeCellManager(){return this._activeCellManager}get id(){return this._id}set id(e){this._id=e}get name(){return this._name}set name(e){this._name=e}get lastRead(){var e;return void 0===this._id?0:null!==(e=JSON.parse(localStorage.getItem(`@jupyter/chat:${this._id}`)||"{}").lastRead)&&void 0!==e?e:0}set lastRead(e){if(void 0===this._id)return;const t=JSON.parse(localStorage.getItem(`@jupyter/chat:${this._id}`)||"{}");t.lastRead=e,localStorage.setItem(`@jupyter/chat:${this._id}`,JSON.stringify(t))}get config(){return this._config}set config(e){const t="stackMessages"in e&&this._config.stackMessages!==e.stackMessages,s="unreadNotifications"in e&&this._config.unreadNotifications!==e.unreadNotifications;this._config={...this._config,...e},this._configChanged.emit(this._config),t&&(this._config.stackMessages?this._messages.slice(1).forEach(((e,t)=>{const s=this._messages[t].sender.username;e.stacked=s===e.sender.username})):this._messages.forEach((e=>{delete e.stacked})),this._messagesUpdated.emit()),s&&!this._config.unreadNotifications&&this._notify(0)}get unreadMessages(){return this._unreadMessages}set unreadMessages(e){var t;const s=this._unreadMessages.filter((t=>!e.includes(t))),a=e.length-this._unreadMessages.length;if(this._unreadMessages=e,this._unreadChanged.emit(this._unreadMessages),this._notify(e.length,a>0),void 0!==this._id&&s.length){let e=!1,a=null!==(t=this.lastRead)&&void 0!==t?t:this.messages[s[0]].time;s.forEach((t=>{this.messages[t].time>a&&(a=this.messages[t].time,e=!0)})),e&&(this.lastRead=a)}}get messagesInViewport(){return this._messagesInViewport}set messagesInViewport(e){this._messagesInViewport=e,this._viewportChanged.emit(e)}get messagesUpdated(){return this._messagesUpdated}get configChanged(){return this._configChanged}get unreadChanged(){return this._unreadChanged}get viewportChanged(){return this._viewportChanged}get focusInputSignal(){return this._focusInputSignal}addMessage(e){}dispose(){this.isDisposed||(this._isDisposed=!0)}get isDisposed(){return this._isDisposed}formatChatMessage(e){return e}messageAdded(e){const t=this._messages.findIndex((t=>t.id===e.id));t>-1&&this._messages.splice(t,1);let s=this._messages.findIndex((t=>t.time>e.time));-1===s&&(s=this._messages.length),this.messagesInserted(s,[e])}messagesInserted(e,t){var s;const a=[],n=[],i=null!==(s=this.lastRead)&&void 0!==s?s:0;if(t.forEach(((t,s)=>{a.push(this.formatChatMessage(t)),t.time>i&&n.push(e+s)})),this._messages.splice(e,0,...a),this._config.stackMessages){const t=e+a.length-1,s=0===e?1:e,n=this._messages.length>t+1?t+1:t;for(let e=s;e<=n;e++){const t=this._messages[e],s=this._messages[e-1].sender.username;t.stacked=s===t.sender.username}}this._addUnreadMessages(n),this._messagesUpdated.emit()}messagesDeleted(e,t){this._messages.splice(e,t),this._messagesUpdated.emit()}focusInput(){this._focusInputSignal.emit()}_addUnreadMessages(e){const t=new Set(this._unreadMessages);e.forEach((e=>t.add(e))),this.unreadMessages=Array.from(t.values())}_notify(e,t=!1){this._commands&&(e&&this._config.unreadNotifications?this._commands.execute("apputils:update-notification",{id:this._notificationId,message:`${e} incoming message(s) ${this._name?"in "+this._name:""}`}).then((s=>{!s&&t&&this._commands.execute("apputils:notify",{type:"info",message:`${e} incoming message(s) in ${this._name}`}).then((e=>{this._notificationId=e}))})):this._notificationId&&(this._commands.execute("apputils:dismiss-notification",{id:this._notificationId}),this._notificationId=null))}}var me=s(7262),ge=s(2697);class pe extends ge.YDocument{constructor(e){super(e),this.version="1.0.0",this._usersObserver=e=>{const t=new Array;e.keysChanged.forEach((s=>{const a=e.changes.keys.get(s);if(a)switch(a.action){case"add":t.push({key:s,newValue:this._users.get(s),type:"add"});break;case"delete":t.push({key:s,oldValue:a.oldValue,type:"remove"});break;case"update":t.push({key:s,oldValue:a.oldValue,newValue:this._users.get(s),type:"change"})}})),this._changed.emit({userChange:t})},this._messagesObserver=e=>{const t=e.delta;this._changed.emit({messageChanges:t})},this._metadataObserver=e=>{const t=new Array;e.changes.keys.forEach(((e,s)=>{switch(e.action){case"add":t.push({key:s,newValue:this._metadata.get(s),type:"add"});break;case"delete":t.push({key:s,oldValue:e.oldValue,type:"remove"});break;case"update":t.push({key:s,oldValue:e.oldValue,newValue:this._metadata.get(s),type:"change"})}})),this._changed.emit({metadataChanges:t})},this._users=this.ydoc.getMap("users"),this._users.observe(this._usersObserver),this._messages=this.ydoc.getArray("messages"),this._messages.observe(this._messagesObserver),this._metadata=this.ydoc.getMap("metadata"),this._metadata.observe(this._metadataObserver)}static create(e){return new pe(e)}get id(){return this._metadata.get("id")||""}get users(){return me.JSONExt.deepCopy(this._users.toJSON())}get messages(){return me.JSONExt.deepCopy(this._messages.toJSON())}getUser(e){if(e)return this._users.get(e)}setUser(e){this.transact((()=>{this._users.set(e.username,e)}))}getMessage(e){return this._messages.get(e)}addMessage(e){this.transact((()=>{this._messages.push([e])}))}updateMessage(e,t){this.transact((()=>{this._messages.delete(e),this._messages.insert(e,[t])}))}getMessageIndex(e){return this._messages.toArray().findIndex((t=>t.id===e))}deleteMessage(e){this.transact((()=>{this._messages.delete(e)}))}}class fe extends ue{constructor(e){super(e),this.collaborative=!0,this._onchange=(e,t)=>{if(t.messageChanges){const e=t.messageChanges;let s=0;e.forEach((e=>{if(e.retain)s+=e.retain;else if(e.insert){const t=e.insert.map((e=>({...e,sender:this.sharedModel.getUser(e.sender)||{username:"User undefined"}})));this.messagesInserted(s,t),s+=t.length}else e.delete&&this.messagesDeleted(s,e.delete)}))}t.metadataChanges&&t.metadataChanges.forEach((e=>{"id"===e.key&&(this.id=e.newValue)}))},this.defaultKernelName="",this.defaultKernelLanguage="",this._dirty=!1,this._readOnly=!1,this._disposed=new he.Signal(this),this._contentChanged=new he.Signal(this),this._stateChanged=new he.Signal(this),this._user=e.user||{username:"user undefined"};const{widgetConfig:t,sharedModel:s}=e;this._sharedModel=s||pe.create(),this.id=this._sharedModel.id,this.sharedModel.changed.connect(this._onchange,this),this.config=t.config,t.configChanged.connect(((e,t)=>{this.config=t}))}get user(){return this._user}get sharedModel(){return this._sharedModel}get contentChanged(){return this._contentChanged}get stateChanged(){return this._stateChanged}get dirty(){return this._dirty}set dirty(e){this._dirty=e}get readOnly(){return this._readOnly}set readOnly(e){this._readOnly=e}get disposed(){return this._disposed}dispose(){this.isDisposed||(super.dispose(),this._sharedModel.dispose(),this._disposed.emit(),he.Signal.clearData(this))}toString(){return JSON.stringify({},null,2)}fromString(e){}toJSON(){return JSON.parse(this.toString())}fromJSON(e){}addMessage(e){const t={type:"msg",id:me.UUID.uuid4(),body:e.body,time:Date.now()/1e3,sender:this._user.username,raw_time:!0};this.sharedModel.getUser(this._user.username)!==this._user&&this.sharedModel.setUser(this._user),this.sharedModel.addMessage(t)}updateMessage(e,t){const s=this.sharedModel.getMessageIndex(e);let a=this.sharedModel.getMessage(s);if(a)a.body=t.body,a.edited=!0;else{const s=t.sender.username;a={type:"msg",id:e||me.UUID.uuid4(),body:t.body,time:t.time||Date.now()/1e3,sender:s,edited:!0}}this.sharedModel.updateMessage(s,a)}deleteMessage(e){const t=this.sharedModel.getMessageIndex(e),s=this.sharedModel.getMessage(t);s?(s.body="",s.deleted=!0,this.sharedModel.updateMessage(t,s)):console.error("The message to delete does not exist")}}var ve=s(1473);const _e={name:"chat",displayName:"Chat",mimeTypes:["text/json","application/json"],extensions:[".chat"],fileFormat:"text",contentType:"chat",icon:F.Or},Ce=new me.Token("jupyter-collaborative-chat:IChatFactory"),ye={createChat:"collaborative-chat:create",openChat:"collaborative-chat:open",moveToSide:"collaborative-chat:moveToSide",markAsRead:"collaborative-chat:markAsRead",focusInput:"collaborative-chat:focusInput"},be=new me.Token("jupyter-collaborative-chat:IChatPanel"),we=new me.Token("jupyter-collaborative-chat:IActiveCellManager"),Ee="jp-collab-chat-title-unread";class Me extends de.DocumentWidget{constructor(e){super(e),this._unreadChanged=(e,t)=>{t.length?this.title.className.includes(Ee)||(this.title.className+=` ${Ee}`):this.title.className=this.title.className.replace(Ee,"")},this.addClass("jp-collab-chat-main-panel"),this.model.name=this.context.localPath,this.model.unreadChanged.connect(this._unreadChanged)}dispose(){this.model.unreadChanged.disconnect(this._unreadChanged),this.context.dispose(),this.content.dispose(),super.dispose()}get model(){return this.context.model}}class xe extends p.SidePanel{constructor(e){super(e),this.updateChatNames=async()=>{const e=_e.extensions[0];this._drive.get(".").then((t=>{const s=t.content.filter((t=>"file"===t.type&&t.name.endsWith(e))).map((t=>ve.PathExt.basename(t.name,e)));this._chatNamesChanged.emit(s)})).catch((e=>console.error("Error getting the chat files from drive",e)))},this._chatSelected=e=>{const t=e.target.value;if("-"===t)return;const s=this.widgets.findIndex((e=>e.name===t));-1===s?this._commands.execute(ye.openChat,{filepath:`${t}${_e.extensions[0]}`,inSidePanel:!0}):this.widgets[s].isVisible||this.content.expand(s),e.target.selectedIndex=0},this._chatNamesChanged=new he.Signal(this),this._config={},this.addClass("jp-collab-chat-sidepanel"),this._commands=e.commands,this._drive=e.drive,this._rmRegistry=e.rmRegistry,this._themeManager=e.themeManager,this._autocompletionRegistry=e.autocompletionRegistry;const t=new p.CommandToolbarButton({commands:this._commands,id:ye.createChat,args:{inSidePanel:!0},icon:p.addIcon});t.addClass("jp-collab-chat-add"),this.toolbar.addItem("createChat",t),this._openChat=p.ReactWidget.create(i().createElement(Ie,{chatNamesChanged:this._chatNamesChanged,handleChange:this._chatSelected.bind(this)})),this._openChat.addClass("jp-collab-chat-open"),this.toolbar.addItem("openChat",this._openChat),this.content.expansionToggled.connect(this._onExpansionToggled,this)}get config(){return this._config}set config(e){this._config={...this._config,...e},this.widgets.forEach((t=>{t.model.config=e}))}addChat(e,t){const s=this.content;for(let e=0;e<this.widgets.length;e++)s.collapse(e);e.name=t;const a=new ce({model:e,rmRegistry:this._rmRegistry,themeManager:this._themeManager,autocompletionRegistry:this._autocompletionRegistry});this.addWidget(new Se({name:t,widget:a,commands:this._commands}))}onAfterShow(e){var t;null===(t=this._openChat.renderPromise)||void 0===t||t.then((()=>this.updateChatNames()))}_onExpansionToggled(e,t){if(this.widgets[t].isVisible)for(let s=0;s<this.widgets.length;s++)s!==t&&e.collapse(s)}}class Se extends p.PanelWithToolbar{constructor(e){var t;super(e),this._unreadChanged=(e,t)=>{this._markAsRead.enabled=t.length>0},this.addClass("jp-collab-chat-section"),this._name=e.name,this.title.label=this._name,this.title.caption=this._name,this.toolbar.addClass("jp-collab-chat-toolbar"),this._markAsRead=new p.ToolbarButton({icon:F.Cg,iconLabel:"Mark chat as read",className:"jp-mod-styled",onClick:()=>this.model.unreadMessages=[]});const s=new p.ToolbarButton({icon:p.launchIcon,iconLabel:"Move the chat to the main area",className:"jp-mod-styled",onClick:()=>{this.model.dispose(),e.commands.execute(ye.openChat,{filepath:`${this._name}${_e.extensions[0]}`}),this.dispose()}}),a=new p.ToolbarButton({icon:p.closeIcon,iconLabel:"Close the chat",className:"jp-mod-styled",onClick:()=>{this.model.dispose(),this.dispose()}});this.toolbar.addItem("collaborativeChat-markRead",this._markAsRead),this.toolbar.addItem("collaborativeChat-moveMain",s),this.toolbar.addItem("collaborativeChat-close",a),this.addWidget(e.widget),null===(t=this.model.unreadChanged)||void 0===t||t.connect(this._unreadChanged),this._markAsRead.enabled=this.model.unreadMessages.length>0,e.widget.node.style.height="100%"}get name(){return this._name}get model(){return this.widgets[0].model}dispose(){var e;null===(e=this.model.unreadChanged)||void 0===e||e.disconnect(this._unreadChanged),super.dispose()}}function Ie({chatNamesChanged:e,handleChange:t}){const[s,a]=(0,n.useState)([]);return e.connect(((e,t)=>{a(t)})),i().createElement(p.HTMLSelect,{onChange:t},i().createElement("option",{value:"-"},"Open a chat"),s.map((e=>i().createElement("option",{value:e},e))))}class ke{constructor(e){this._configChanged=new he.Signal(this),this._config=e}get config(){return this._config}set config(e){this._config={...this._config,...e},this._configChanged.emit(e)}get configChanged(){return this._configChanged}}class Ae extends de.ABCWidgetFactory{constructor(e){super(e),this._themeManager=e.themeManager,this._rmRegistry=e.rmRegistry,this._autocompletionRegistry=e.autocompletionRegistry}createNewWidget(e){return e.rmRegistry=this._rmRegistry,e.themeManager=this._themeManager,e.autocompletionRegistry=this._autocompletionRegistry,new Me({context:e,content:new ce(e)})}}class Ne{constructor(e){var t;this.collaborative=!0,this._disposed=!1,this._user=e.user,this._widgetConfig=e.widgetConfig,this._commands=e.commands,this._activeCellManager=null!==(t=e.activeCellManager)&&void 0!==t?t:null}get name(){return"chat"}get contentType(){return"chat"}get fileFormat(){return"text"}get isDisposed(){return this._disposed}dispose(){this._disposed=!0}preferredLanguage(e){return""}createNew(e){return new fe({...e,user:this._user,widgetConfig:this._widgetConfig,commands:this._commands,activeCellManager:this._activeCellManager})}}}}]);